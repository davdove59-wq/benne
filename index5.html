<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>C√¢blerie ‚Äì Suivi Bennes & Big Bags</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #050611;
      --fg: #f7f7ff;
      --muted: #a1a4c2;
      --accent: #ffb300;
      --accent-soft: rgba(255, 179, 0, 0.12);
      --danger: #ff4b81;
      --card-bg: rgba(10, 11, 30, 0.96);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 22px 60px rgba(0, 0, 0, 0.6);
      --trans-fast: 0.18s ease-out;
      --trans-med: 0.28s ease-out;
      --font-display: "Space Grotesk", system-ui, sans-serif;
      --font-body: "IBM Plex Sans", system-ui, sans-serif;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at 10% 0%, #11162e 0, #050611 45%, #000000 100%);
      color: var(--fg);
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
      scroll-behavior: smooth;
    }

    body::before {
      content: "";
      position: fixed;
      inset: -60px;
      pointer-events: none;
      background:
        radial-gradient(circle at 0 0, rgba(255, 179, 0, 0.16) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(102, 204, 255, 0.18) 0, transparent 60%);
      mix-blend-mode: screen;
      opacity: 0.9;
      z-index: -2;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='noStitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.16'/%3E%3C/svg%3E");
      mix-blend-mode: soft-light;
      opacity: 0.9;
      z-index: -1;
    }

    main {
      min-height: 100vh;
      padding: 1.1rem 1.1rem 2rem;
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.9rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(22px);
      background:
        radial-gradient(circle at 0 0, rgba(255, 179, 0, 0.2) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(102, 204, 255, 0.2) 0, transparent 55%),
        rgba(3, 5, 22, 0.9);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
      position: sticky;
      top: 0.6rem;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-mark {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: conic-gradient(from 210deg, #ffb300, #ff4b81, #66ccff, #ffb300);
      padding: 2px;
      position: relative;
    }

    .brand-mark::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: inherit;
      background:
        radial-gradient(circle at 30% 0, rgba(255, 255, 255, 0.35), transparent 55%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.09), transparent 60%),
        #050616;
    }

    .brand-text h1 {
      font-family: var(--font-display);
      font-size: 1.15rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      margin: 0;
    }

    .brand-text span {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .pill {
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(14, 16, 36, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #00d27f;
      box-shadow: 0 0 0 3px rgba(0, 210, 127, 0.3);
    }

    .pill-secondary {
      border-color: rgba(255, 255, 255, 0.1);
      background: rgba(5, 7, 24, 0.9);
    }

    @media (max-width: 700px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        border-radius: 22px;
      }
      .header-meta {
        align-items: flex-start;
      }
    }

    section {
      border-radius: var(--radius-lg);
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 1.1rem 1.1rem 1rem;
      position: relative;
      overflow: hidden;
    }

    section::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 10% 0, rgba(255, 179, 0, 0.18) 0, transparent 55%);
      mix-blend-mode: soft-light;
      opacity: 0;
      transition: opacity var(--trans-med);
      pointer-events: none;
    }

    section:hover::before {
      opacity: 1;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.9rem;
    }

    .section-title {
      font-family: var(--font-display);
      font-size: 0.95rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .badge {
      font-size: 0.6rem;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      border: 1px solid rgba(255, 255, 255, 0.16);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .section-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
      max-width: 320px;
      line-height: 1.4;
    }

    .tagline {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .tagline strong {
      color: var(--accent);
    }

    label {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      display: block;
      margin-bottom: 0.25rem;
    }

    .field-row,
    .field-row-3 {
      display: grid;
      gap: 0.8rem;
      margin-bottom: 0.8rem;
    }

    .field-row {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .field-row-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 720px) {
      .field-row,
      .field-row-3 {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    select,
    input[type="number"],
    input[type="text"],
    input[type="date"] {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(6, 8, 28, 0.96);
      color: var(--fg);
      font-family: var(--font-body);
      font-size: 0.88rem;
      padding: 0.55rem 0.65rem;
      outline: none;
      transition:
        border-color var(--trans-fast),
        box-shadow var(--trans-fast),
        background var(--trans-fast),
        transform var(--trans-fast);
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    select:focus,
    input:focus {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(255, 179, 0, 0.5),
        0 0 0 10px rgba(255, 179, 0, 0.07);
      transform: translateY(-1px);
      background: rgba(10, 12, 34, 0.98);
    }

    select {
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 55%),
        linear-gradient(135deg, var(--muted) 45%, transparent 50%);
      background-position:
        calc(100% - 14px) 50%,
        calc(100% - 9px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 1.8rem;
    }

    .inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.3rem;
    }

    .text-muted {
      color: var(--muted);
      font-size: 0.7rem;
    }

    button {
      font-family: var(--font-body);
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.78rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      padding: 0.55rem 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: linear-gradient(120deg, #ffb300, #ff7c4b);
      color: #130b02;
      box-shadow: 0 14px 30px rgba(255, 179, 0, 0.35);
      transition:
        transform var(--trans-fast),
        box-shadow var(--trans-fast),
        filter var(--trans-fast),
        background-position 0.2s ease-out;
      background-size: 180% 180%;
      background-position: 0% 50%;
    }

    button span.icon {
      font-size: 0.95rem;
    }

    button:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 18px 40px rgba(255, 179, 0, 0.4);
      background-position: 100% 50%;
      filter: brightness(1.03);
    }

    button:active {
      transform: translateY(0) scale(0.99);
      box-shadow: 0 10px 24px rgba(255, 179, 0, 0.25);
      filter: brightness(0.96);
    }

    button.secondary {
      background: linear-gradient(120deg, rgba(7, 11, 34, 0.98), rgba(7, 11, 34, 0.98));
      color: var(--muted);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.14);
      background-size: 100% 100%;
    }

    button.secondary:hover {
      background: linear-gradient(120deg, rgba(11, 15, 42, 0.99), rgba(12, 18, 50, 0.99));
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.8);
      filter: none;
    }

    button.secondary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.7);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.4rem;
    }

    .totals-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.6rem;
      margin-top: 0.2rem;
    }

    @media (max-width: 720px) {
      .totals-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .stat-card {
      position: relative;
      padding: 0.6rem 0.65rem;
      border-radius: var(--radius-md);
      background:
        radial-gradient(circle at 0 0, rgba(255, 179, 0, 0.16) 0, transparent 55%),
        rgba(7, 9, 32, 0.97);
      border: 1px solid rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    .stat-card.alt {
      background:
        radial-gradient(circle at 100% 0, rgba(102, 204, 255, 0.2) 0, transparent 55%),
        rgba(7, 9, 32, 0.97);
    }

    .stat-label {
      font-size: 0.65rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: 0.98rem;
      letter-spacing: 0.04em;
    }

    .stat-chip {
      font-size: 0.6rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.3rem;
      font-size: 0.78rem;
    }

    thead {
      background: linear-gradient(90deg, rgba(10, 12, 40, 0.98), rgba(7, 9, 32, 0.98));
      position: sticky;
      top: 3.3rem;
      z-index: 20; /* Augment√© pour mieux passer par-dessus */
    }

    th, td {
      padding: 0.4rem 0.35rem;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    tbody tr:nth-child(odd) {
      background: rgba(7, 9, 32, 0.96);
    }

    tbody tr:nth-child(even) {
      background: rgba(5, 7, 26, 0.98);
    }

    tbody tr:hover {
      background: rgba(18, 23, 60, 0.99);
    }

    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    td.actions {
      text-align: right;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 0.1rem 0.4rem;
      font-size: 0.65rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--muted);
      background: rgba(8, 11, 34, 0.96);
    }

    .chip.highlight {
      border-color: rgba(255, 179, 0, 0.8);
      color: var(--accent);
      background: rgba(255, 179, 0, 0.08);
    }

    .chip.badge-small {
      padding: 0.06rem 0.32rem;
      font-size: 1rem;
    }

    .icon-btn {
      border-radius: 999px;
      width: 24px;
      height: 24px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(6, 8, 28, 0.98);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
      margin-left: 0.2rem;
      transition:
        background var(--trans-fast),
        transform var(--trans-fast),
        border-color var(--trans-fast),
        color var(--trans-fast),
        box-shadow var(--trans-fast);
    }

    .icon-btn:hover {
      background: rgba(255, 75, 129, 0.12);
      border-color: rgba(255, 75, 129, 0.9);
      color: var(--danger);
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.7);
    }

    .icon-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .filters-row > div {
      min-width: 130px;
      flex: 1;
    }

    .chart-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background:
        radial-gradient(circle at 100% 0, rgba(102, 204, 255, 0.18) 0, transparent 55%),
        rgba(7, 9, 32, 0.97);
      padding: 0.6rem;
      margin-top: 0.3rem;
    }

    canvas {
      width: 100%;
      max-height: 260px;
      display: block;
    }

    .note {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 0.4rem;
      line-height: 1.4;
    }

    .error-msg {
      display: none;
      margin-top: 0.25rem;
      font-size: 0.7rem;
      color: var(--danger);
    }

    .error-msg.visible {
      display: block;
    }

    .highlight-strip {
      position: absolute;
      inset-inline: -25%;
      top: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255, 179, 0, 0.8), transparent);
      opacity: 0.8;
    }

    .fade-in {
      opacity: 0;
      transform: translateY(12px);
      animation: enter 0.6s var(--trans-med) forwards;
    }
    .delay-1 { animation-delay: 0.08s; }
    .delay-2 { animation-delay: 0.16s; }
    .delay-3 { animation-delay: 0.24s; }
    .delay-4 { animation-delay: 0.32s; }

    @keyframes enter {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
<main>
  <header class="fade-in delay-1" aria-label="En-t√™te de l'application">
    <div class="brand">
      <div class="brand-mark" aria-hidden="true"></div>
      <div class="brand-text">
        <h1>Recyclage - NEXANS</h1>
        <span>Bennes &amp; Big Bags ¬∑ Poids net</span>
      </div>
    </div>
    <div class="header-meta">
      <div class="pill">
        <span class="pill-dot"></span>
        Session op√©rateur unique
      </div>
      <div class="pill pill-secondary">
        Kg uniquement ¬∑ Export CSV &amp; Excel
      </div>
    </div>
  </header>

  <!-- Saisie -->
  <section id="saisie-section" class="fade-in delay-2" aria-labelledby="saisie-titre">
    <div class="highlight-strip" aria-hidden="true"></div>
    <div class="section-header">
      <div>
        <div id="saisie-titre" class="section-title">
          Saisie pes√©e benne / big bag
          <span class="badge">C√¢blerie</span>
        </div>
        <p class="section-subtitle">
          1. Choisir le secteur ¬∑ 2. Choisir la benne ou le big bag (tare affich√©e)
          ¬∑ 3. Entrer le poids brut en kg. Le poids net est calcul√© automatiquement.
        </p>
      </div>
      <div class="tagline">
        Triage par <strong>secteur</strong> &amp; <strong>type</strong>
      </div>
    </div>

    <form id="entry-form" autocomplete="off">
      <div class="field-row-3">
        <div>
          <label for="sector">Secteur</label>
          <select id="sector" required>
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            <!-- Les options seront tri√©es par JS -->
          </select>
        </div>

        <div>
          <label for="container">Benne / Big Bag</label>
          <select id="container" required disabled>
            <option value="">‚Äî Choisir un secteur ‚Äî</option>
          </select>
          <div class="inline">
            <span class="text-muted" id="tare-info">Tare : ‚Äî kg</span>
            <span class="chip badge-small" id="container-type">Type : ‚Äî</span>
          </div>
        </div>

        <div>
          <label for="wasteType">Type de d√©chet</label>
          <input id="wasteType" type="text" readonly placeholder="Auto depuis la benne" />
          <div class="inline">
            <span class="text-muted">Benne : tare auto ¬∑ Big bag : tare 0</span>
          </div>
        </div>
      </div>

      <div class="field-row-3">
        <div>
          <label for="grossWeight">Poids brut (kg)</label>
          <input id="grossWeight" type="number" step="0.01" min="0" placeholder="ex : 482.30" required />
          <div class="inline">
            <span class="text-muted">Net = brut ‚Äì tare</span>
            <span class="chip badge-small" id="net-preview">Net : ‚Äî kg</span>
          </div>
        </div>

        <div>
          <label for="date">Date</label>
          <input id="date" type="date" required />
          <div class="inline">
            <span class="text-muted" id="today-label">Aujourd'hui</span>
          </div>
        </div>

        <div>
          <label for="comment">Commentaire (optionnel)</label>
          <input id="comment" type="text" placeholder="N¬∞ lot, info, etc." />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="secondary" id="reset-form">
          <span class="icon">‚ü≤</span>
          Effacer
        </button>
        <button type="submit">
          <span class="icon">‚ûï</span>
          Ajouter la pes√©e
        </button>
      </div>
      <p class="error-msg" id="form-error"></p>
    </form>
  </section>

  <!-- Totaux & Stats -->
  <section id="stats-section" class="fade-in delay-3" aria-labelledby="stats-titre">
    <div class="highlight-strip" aria-hidden="true"></div>
    <div class="section-header">
      <div>
        <div id="stats-titre" class="section-title">
          Totaux &amp; statistiques
          <span class="badge">Temps r√©el</span>
        </div>
        <p class="section-subtitle">
          Suivi global des poids nets enregistr√©s. Les totaux tiennent compte des
          filtres appliqu√©s dans l‚Äôhistorique (dates, secteur, type).
        </p>
      </div>
    </div>

    <div class="totals-grid">
      <div class="stat-card">
        <div class="stat-label">Total filtr√©</div>
        <div class="stat-value" id="total-global">0.00 kg</div>
        <div class="inline" style="margin-top:0.2rem;">
          <span class="stat-chip">Poids net (kg)</span>
        </div>
      </div>
      <div class="stat-card alt">
        <div class="stat-label">Total du jour</div>
        <div class="stat-value" id="total-today">0.00 kg</div>
        <div class="inline" style="margin-top:0.2rem;">
          <span class="stat-chip" id="today-label-2">Aujourd'hui</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Nombre de pes√©es</div>
        <div class="stat-value" id="entries-count">0</div>
        <div class="inline" style="margin-top:0.2rem;">
          <span class="stat-chip">Lignes filtr√©es</span>
        </div>
      </div>
    </div>

    <div class="chart-wrapper" aria-label="R√©partition par type de d√©chet">
      <div class="inline" style="margin-bottom:0.2rem;">
        <span class="stat-label">R√©partition par type</span>
        <span class="chip badge-small" id="chart-total">Total : 0.00 kg</span>
      </div>
      <canvas id="typeChart" height="190"></canvas>
    </div>

    <p class="note">
      Astuce iPhone : ouvrir cette page dans Safari, puis ‚ÄúPartager &gt; Ajouter √†
      l‚Äô√©cran d‚Äôaccueil‚Äù pour l‚Äôutiliser comme une vraie application, m√™me hors ligne.
    </p>
  </section>

  <!-- Historique & Export -->
  <section id="history-section" class="fade-in delay-4" aria-labelledby="history-titre">
    <div class="highlight-strip" aria-hidden="true"></div>
    <div class="section-header">
      <div>
        <div id="history-titre" class="section-title">
          Historique des pes√©es
          <span class="badge">Filtres &amp; export</span>
        </div>
        <p class="section-subtitle">
          Toutes les pes√©es de bennes et big bags. Utiliser les filtres pour cibler
          une p√©riode, un secteur ou un type, puis exporter en CSV ou Excel.
        </p>
      </div>
      <div class="btn-row">
        <button type="button" class="secondary" id="export-csv">
          <span class="icon">‚¨á</span>
          Export CSV
        </button>
        <button type="button" id="export-xls">
          <span class="icon">üìä</span>
          Export Excel
        </button>
      </div>
    </div>

    <div class="filters-row">
      <div>
        <label for="filter-from">Du</label>
        <input type="date" id="filter-from">
      </div>
      <div>
        <label for="filter-to">Au</label>
        <input type="date" id="filter-to">
      </div>
      <div>
        <label for="filter-sector">Secteur</label>
        <select id="filter-sector">
          <option value="">Tous</option>
          <!-- Les options seront tri√©es par JS -->
        </select>
      </div>
      <div>
        <label for="filter-type">Type</label>
        <select id="filter-type">
          <option value="">Tous</option>
          <option>Alu Nu</option>
          <option>Isol√©</option>
          <option>Arm√©</option>
          <option>Alu Sous Plomb</option>
          <option>Ferraille</option>
          <option>D√©pouille PE</option>
          <option>D√©pouille PVC</option>
          <option>D√©pouille Plomb</option>
          <option>Aiguillettes</option>
          <option>Purge PE</option>
          <option>Purge PVC</option>
        </select>
      </div>
    </div>

    <div style="overflow:auto; max-height: 320px; border-radius: 12px; border:1px solid rgba(255,255,255,0.14);">
      <table aria-label="Liste des pes√©es">
        <thead>
        <tr>
          <th>Date</th>
          <th>Secteur</th>
          <th>Type</th>
          <th>Benne / Big Bag</th>
          <th>Brut (kg)</th>
          <th>Tare (kg)</th>
          <th>Net (kg)</th>
          <th>Commentaire</th>
          <th></th>
        </tr>
        </thead>
        <tbody id="entries-body">
        <!-- G√©n√©r√© en JS -->
        </tbody>
      </table>
    </div>

    <p class="note">
      Les donn√©es sont stock√©es dans le navigateur (localStorage). Penser √†
      exporter r√©guli√®rement les CSV / Excel pour archivage ou sauvegarde externe.
    </p>
  </section>
</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/*
  CONFIGURATION DES SECTEURS, BENNES & BIG BAGS
  --------------------------------------------
  Chaque entr√©e : { id, type, tare, label }
  - type = type de d√©chet (Alu Nu, Ferraille, Purge PE, etc.)
  - tare = kg (0 pour big bag)
*/

const SECTEURS = {
  "Tr√©filage": [
    { id: "T-AN", type: "Alu Nu", tare: 194, label: "Alu Nu ‚Äì 194 kg" },
    { id: "T-FER", type: "Ferraille", tare: 553, label: "Ferraille ‚Äì 553 kg" },
    { id: "T-BB-AIG", type: "Aiguillettes", tare: 0, label: "Big Bag Aiguillettes" }
  ],
  "530": [
    { id: "530-AN", type: "Alu Nu", tare: 160, label: "Alu Nu ‚Äì 160 kg" }
  ],
  "118": [
    { id: "118-AN", type: "Alu Nu", tare: 160, label: "Alu Nu ‚Äì 160 kg" }
  ],
  "Bagger": [
    { id: "BAG-AN", type: "Alu Nu", tare: 155, label: "Alu Nu ‚Äì 155 kg" }
  ],
  "RL": [
    { id: "RL-AN", type: "Alu Nu", tare: 198, label: "Alu Nu ‚Äì 198 kg" },
    { id: "RL-ARM", type: "Arm√©", tare: 198, label: "Arm√© ‚Äì 198 kg" }
  ],
  "Bema": [
    { id: "BEMA-AN", type: "Alu Nu", tare: 120, label: "Alu Nu ‚Äì 120 kg" }
  ],
  "Presse √† Plomb": [
    { id: "PAP-ARM", type: "Arm√©", tare: 214, label: "Arm√© ‚Äì 214 kg" },
    { id: "PAP-ASP", type: "Alu Sous Plomb", tare: 216, label: "Alu Sous Plomb ‚Äì 216 kg" }
  ],
  "Sket": [
    { id: "SKET-AN1", type: "Alu Nu", tare: 141, label: "Alu Nu ‚Äì 141 kg" },
    { id: "SKET-AN2", type: "Alu Nu", tare: 146, label: "Alu Nu ‚Äì 146 kg" },
    { id: "SKET-AN3", type: "Alu Nu", tare: 136, label: "Alu Nu ‚Äì 136 kg" },
    { id: "SKET-AN4", type: "Alu Nu", tare: 200, label: "Alu Nu ‚Äì 200 kg" }
  ],
  "158": [
    { id: "158-AN", type: "Alu Nu", tare: 212, label: "Alu Nu ‚Äì 212 kg" },
    { id: "158-ISO", type: "Isol√©", tare: 194, label: "Isol√© ‚Äì 194 kg" },
    { id: "158-ASP", type: "Alu Sous Plomb", tare: 220, label: "Alu Sous Plomb ‚Äì 220 kg" },
    { id: "158-FER", type: "Ferraille", tare: 196, label: "Ferraille ‚Äì 196 kg" },
    { id: "158-ARM", type: "Arm√©", tare: 198, label: "Arm√© ‚Äì 198 kg" }
  ],
  "Mono": [
    { id: "MONO-AN", type: "Alu Nu", tare: 560, label: "Alu Nu ‚Äì 560 kg" },
    { id: "MONO-ISO", type: "Isol√©", tare: 202, label: "Isol√© ‚Äì 202 kg" },
    { id: "MONO-BB-PPE", type: "Purge PE", tare: 0, label: "Big Bag Purge PE" }
  ],
  "153/156": [
    { id: "153156-AN", type: "Alu Nu", tare: 194, label: "Alu Nu ‚Äì 194 kg" },
    { id: "153156-ASP", type: "Alu Sous Plomb", tare: 230, label: "Alu Sous Plomb ‚Äì 230 kg" },
    { id: "153156-ISO", type: "Isol√©", tare: 160, label: "Isol√© ‚Äì 160 kg" },
    { id: "153156-FER", type: "Ferraille", tare: 196, label: "Ferraille ‚Äì 196 kg" }
  ],
  "153": [
    { id: "153-FER", type: "Ferraille", tare: 160, label: "Ferraille ‚Äì 160 kg" }
  ],
  "156": [
    { id: "156-FER", type: "Ferraille", tare: 160, label: "Ferraille ‚Äì 160 kg" }
  ],
  "Maintenance": [
    { id: "MAINT-FER", type: "Ferraille", tare: 240, label: "Ferraille ‚Äì 240 kg" }
  ],
  "7712": [
    { id: "7712-DPE1", type: "D√©pouille PE", tare: 146, label: "D√©pouille PE ‚Äì 146 kg" },
    { id: "7712-DPE2", type: "D√©pouille PE", tare: 147, label: "D√©pouille PE ‚Äì 147 kg" },
    { id: "7712-DPE3", type: "D√©pouille PE", tare: 143, label: "D√©pouille PE ‚Äì 143 kg" },
    { id: "7712-DPVC1", type: "D√©pouille PVC", tare: 146, label: "D√©pouille PVC ‚Äì 146 kg" },
    { id: "7712-DPVC2", type: "D√©pouille PVC", tare: 147, label: "D√©pouille PVC ‚Äì 147 kg" },
    { id: "7712-DPVC3", type: "D√©pouille PVC", tare: 143, label: "D√©pouille PVC ‚Äì 143 kg" },
    { id: "7712-DPVC4", type: "D√©pouille PVC", tare: 600, label: "D√©pouille PVC ‚Äì 600 kg" }
  ],
  "108": [
    { id: "108-ISO", type: "Isol√©", tare: 194, label: "Isol√© ‚Äì 194 kg" },
    { id: "108-ARM", type: "Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" }
  ],
  "Labo": [
    { id: "LABO-ARM", type: "Arm√©", tare: 194, label: "Arm√© ‚Äì 194 kg" },
    { id: "LABO-AN", type: "Alu Nu", tare: 196, label: "Alu Nu ‚Äì 196 kg" }
  ],
  "PCV4": [
    { id: "PCV4-ISO", type: "Isol√©", tare: 164, label: "Isol√© ‚Äì 164 kg" },
    { id: "PCV4-ARM", type: "Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" }
  ],
  "PCV3": [
    { id: "PCV3-ARM1", type: "Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" },
    { id: "PCV3-ARM2", type: "Arm√©", tare: 164, label: "Arm√© ‚Äì 164 kg" }
  ],
  "Cellules": [
    { id: "CELL-FER", type: "Ferraille", tare: 160, label: "Ferraille ‚Äì 160 kg" },
    { id: "CELL-DPVC", type: "D√©pouille PVC", tare: 160, label: "D√©pouille PVC ‚Äì 160 kg" },
    { id: "CELL-ISO", type: "Isol√©", tare: 160, label: "Isol√© ‚Äì 160 kg" },
    { id: "CELL-AN", type: "Alu Nu", tare: 160, label: "Alu Nu ‚Äì 160 kg" },
    { id: "CELL-ASP", type: "Alu Sous Plomb", tare: 160, label: "Alu Sous Plomb ‚Äì 160 kg" }
  ],
  "PCV": [
    { id: "PCV-ARM", type: "Arm√©", tare: 200, label: "Arm√© ‚Äì 200 kg" },
    { id: "PCV-ISO", type: "Isol√©", tare: 200, label: "Isol√© ‚Äì 200 kg" },
    { id: "PCV-AN", type: "Alu Nu", tare: 200, label: "Alu Nu ‚Äì 200 kg" },
    { id: "PCV-BB-PPVC", type: "Purge PVC", tare: 0, label: "Big Bag Purge PVC" }
  ],
  "Couronneuse": [
    { id: "COUR-ARM1", type: "Arm√©", tare: 400, label: "Arm√© ‚Äì 400 kg" },
    { id: "COUR-ARM2", type: "Arm√©", tare: 98, label: "Arm√© ‚Äì 98 kg" }
  ],
  "Brondel": [
    { id: "BRON-ARM", type: "Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" },
    { id: "BRON-ISO1", type: "Isol√©", tare: 160, label: "Isol√© ‚Äì 160 kg" },
    { id: "BRON-ISO2", type: "Isol√©", tare: 536, label: "Isol√© ‚Äì 536 kg" }
  ],
  "Cisaille": [
    { id: "CIS-ARM", type: "Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" },
    { id: "CIS-ISO", type: "Isol√©", tare: 164, label: "Isol√© ‚Äì 164 kg" },
    { id: "CIS-AN", type: "Alu Nu", tare: 164, label: "Alu Nu ‚Äì 164 kg" },
    { id: "CIS-ASP", type: "Alu Sous Plomb", tare: 160, label: "Alu Sous Plomb ‚Äì 160 kg" }
  ]
};

/* DOM elements */
const sectorEl = document.getElementById("sector");
const containerEl = document.getElementById("container");
const tareInfoEl = document.getElementById("tare-info");
const containerTypeEl = document.getElementById("container-type");
const wasteTypeEl = document.getElementById("wasteType");
const grossWeightEl = document.getElementById("grossWeight");
const netPreviewEl = document.getElementById("net-preview");
const dateEl = document.getElementById("date");
const commentEl = document.getElementById("comment");
const formErrorEl = document.getElementById("form-error");

const filterFromEl = document.getElementById("filter-from");
const filterToEl = document.getElementById("filter-to");
const filterSectorEl = document.getElementById("filter-sector");
const filterTypeEl = document.getElementById("filter-type");

const totalGlobalEl = document.getElementById("total-global");
const totalTodayEl = document.getElementById("total-today");
const entriesCountEl = document.getElementById("entries-count");
const chartTotalEl = document.getElementById("chart-total");
const entriesBody = document.getElementById("entries-body");

const exportCsvBtn = document.getElementById("export-csv");
const exportXlsBtn = document.getElementById("export-xls");

/* Local storage */
const STORAGE_KEY = "cablerie_dechets_entries_v1";

function loadEntries() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  } catch (e) {
    console.error("Erreur lecture storage", e);
    return [];
  }
}

function saveEntries(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

let entries = loadEntries();
let chartInstance = null;

/* Init date du jour */
(function initDates() {
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  const iso = `${yyyy}-${mm}-${dd}`;
  dateEl.value = iso;
  filterFromEl.value = iso;
  filterToEl.value = iso;
  const label = `Aujourd'hui (${dd}/${mm}/${String(yyyy).slice(-2)})`;
  document.getElementById("today-label").textContent = label;
  document.getElementById("today-label-2").textContent = label;
})();

/* Fonction pour trier les options d'un select */
function sortSelectOptions(selectElement) {
  const options = Array.from(selectElement.options);
  // Garder la premi√®re option (placeholder) en premier
  const placeholder = options.shift();
  options.sort((a, b) => a.textContent.localeCompare(b.textContent));
  selectElement.innerHTML = ""; // Vider le select
  selectElement.appendChild(placeholder); // Ajouter le placeholder
  options.forEach(option => selectElement.appendChild(option)); // Ajouter les options tri√©es
}

/* Remplir et trier les secteurs */
function populateAndSortSectors() {
  const sectorSelect = document.getElementById("sector");
  const filterSectorSelect = document.getElementById("filter-sector");

  // R√©cup√©rer les cl√©s de SECTEURS et les trier
  const sortedSectors = Object.keys(SECTEURS).sort((a, b) => a.localeCompare(b));

  // Vider les selects et ajouter le placeholder
  sectorSelect.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>';
  filterSectorSelect.innerHTML = '<option value="">Tous</option>';

  // Remplir les selects avec les secteurs tri√©s
  sortedSectors.forEach(sector => {
    const option1 = document.createElement("option");
    option1.value = sector;
    option1.textContent = sector;
    sectorSelect.appendChild(option1);

    const option2 = document.createElement("option");
    option2.value = sector;
    option2.textContent = sector;
    filterSectorSelect.appendChild(option2);
  });
}

populateAndSortSectors(); // Appeler la fonction au d√©marrage

/* Mise √† jour des bennes selon secteur */
sectorEl.addEventListener("change", () => {
  const secteur = sectorEl.value;
  containerEl.innerHTML = "";
  wasteTypeEl.value = "";
  tareInfoEl.textContent = "Tare : ‚Äî kg";
  containerTypeEl.textContent = "Type : ‚Äî";
  containerEl.disabled = true;

  if (!secteur || !SECTEURS[secteur]) {
    return;
  }

  containerEl.disabled = false;
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "‚Äî S√©lectionner benne / big bag ‚Äî";
  containerEl.appendChild(placeholder);

  // Obtenir les conteneurs pour le secteur et les trier par label
  const containers = SECTEURS[secteur].slice().sort((a, b) => a.label.localeCompare(b.label));

  containers.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.label;
    opt.dataset.tare = c.tare;
    opt.dataset.type = c.type;
    containerEl.appendChild(opt);
  });
});

/* Quand on choisit une benne/big bag */
containerEl.addEventListener("change", () => {
  const opt = containerEl.options[containerEl.selectedIndex];
  if (!opt || !opt.dataset.tare) {
    tareInfoEl.textContent = "Tare : ‚Äî kg";
    wasteTypeEl.value = "";
    containerTypeEl.textContent = "Type : ‚Äî";
    updateNetPreview();
    return;
  }
  const tare = parseFloat(opt.dataset.tare);
  const type = opt.dataset.type;
  tareInfoEl.textContent = `Tare : ${tare.toFixed(2)} kg`;
  wasteTypeEl.value = type;
  const mode = tare === 0 ? "Big Bag (tare 0)" : "Benne (tare auto)";
  containerTypeEl.textContent = `Type : ${type} ¬∑ ${mode}`;
  updateNetPreview();
});

/* Calcul net preview */
function getCurrentTare() {
  const opt = containerEl.options[containerEl.selectedIndex];
  if (!opt || !opt.dataset.tare) return 0;
  const t = parseFloat(opt.dataset.tare);
  return isNaN(t) ? 0 : t;
}

function updateNetPreview() {
  const brut = parseFloat((grossWeightEl.value || "").replace(",", "."));
  if (isNaN(brut) || brut <= 0) {
    netPreviewEl.textContent = "Net : ‚Äî kg";
    return;
  }
  const tare = getCurrentTare();
  const net = Math.max(brut - tare, 0);
  netPreviewEl.textContent = `Net : ${net.toFixed(2)} kg`;
}

grossWeightEl.addEventListener("input", updateNetPreview);

/* Ajout d'une entr√©e */
document.getElementById("entry-form").addEventListener("submit", (e) => {
  e.preventDefault();
  formErrorEl.textContent = "";
  formErrorEl.classList.remove("visible");

  const secteur = sectorEl.value;
  const contId = containerEl.value;
  const opt = containerEl.options[containerEl.selectedIndex];
  const date = dateEl.value;
  const comment = commentEl.value.trim();
  const brut = parseFloat((grossWeightEl.value || "").replace(",", "."));

  if (!secteur || !contId || !opt || !opt.dataset.type || !date || isNaN(brut) || brut <= 0) {
    formErrorEl.textContent = "Compl√©ter secteur, benne/big bag, date et un poids brut valide.";
    formErrorEl.classList.add("visible");
    return;
  }

  const tare = parseFloat(opt.dataset.tare) || 0;
  const type = opt.dataset.type;
  const net = Math.max(brut - tare, 0);

  const entry = {
    id: Date.now(),
    date,
    sector: secteur,
    containerId: contId,
    containerLabel: opt.textContent,
    wasteType: type,
    gross: brut,
    tare,
    net,
    comment
  };

  entries.push(entry);
  saveEntries(entries);
  renderAll();

  // reset partiel
  grossWeightEl.value = "";
  commentEl.value = "";
  updateNetPreview();
});

/* Reset complet */
document.getElementById("reset-form").addEventListener("click", () => {
  sectorEl.value = "";
  containerEl.innerHTML = '<option value="">‚Äî Choisir un secteur ‚Äî</option>';
  containerEl.disabled = true;
  tareInfoEl.textContent = "Tare : ‚Äî kg";
  containerTypeEl.textContent = "Type : ‚Äî";
  wasteTypeEl.value = "";
  grossWeightEl.value = "";
  commentEl.value = "";
  formErrorEl.textContent = "";
  formErrorEl.classList.remove("visible");
  updateNetPreview();
});

/* Filtres */
[filterFromEl, filterToEl, filterSectorEl, filterTypeEl].forEach(el => {
  el.addEventListener("change", () => renderAll());
});

function applyFilters(list) {
  const from = filterFromEl.value;
  const to = filterToEl.value;
  const sec = filterSectorEl.value;
  const type = filterTypeEl.value;

  return list.filter(e => {
    if (from && e.date < from) return false;
    if (to && e.date > to) return false;
    if (sec && e.sector !== sec) return false;
    if (type && e.wasteType !== type) return false;
    return true;
  });
}

/* Rendu tableau */
function renderTable() {
  const filtered = applyFilters(entries);
  entriesBody.innerHTML = "";

  if (!filtered.length) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 9;
    td.textContent = "Aucune pes√©e avec les filtres actuels.";
    td.style.textAlign = "center";
    td.style.padding = "0.7rem";
    td.style.color = "#a1a4c2";
    tr.appendChild(td);
    entriesBody.appendChild(tr);
    return;
  }

  filtered
    .slice()
    .sort((a, b) => (a.date === b.date ? a.id - b.id : a.date.localeCompare(b.date)))
    .forEach(e => {
      const tr = document.createElement("tr");

      const dateTd = document.createElement("td");
      dateTd.textContent = e.date;
      tr.appendChild(dateTd);

      const sectorTd = document.createElement("td");
      sectorTd.textContent = e.sector;
      tr.appendChild(sectorTd);

      const typeTd = document.createElement("td");
      typeTd.innerHTML = `<span class="chip">${e.wasteType}</span>`;
      tr.appendChild(typeTd);

      const contTd = document.createElement("td");
      contTd.textContent = e.containerLabel || e.containerId;
      tr.appendChild(contTd);

      const brutTd = document.createElement("td");
      brutTd.textContent = e.gross.toFixed(2);
      tr.appendChild(brutTd);

      const tareTd = document.createElement("td");
      tareTd.textContent = e.tare.toFixed(2);
      tr.appendChild(tareTd);

      const netTd = document.createElement("td");
      netTd.innerHTML = `<span class="chip highlight">${e.net.toFixed(2)} kg</span>`;
      tr.appendChild(netTd);

      const comTd = document.createElement("td");
      comTd.textContent = e.comment || "";
      tr.appendChild(comTd);

      const actTd = document.createElement("td");
      actTd.className = "actions";
      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "icon-btn";
      delBtn.title = "Supprimer la ligne";
      delBtn.textContent = "‚úï";
      delBtn.addEventListener("click", () => {
        if (confirm("Supprimer cette pes√©e ?")) {
          entries = entries.filter(x => x.id !== e.id);
          saveEntries(entries);
          renderAll();
        }
      });
      actTd.appendChild(delBtn);
      tr.appendChild(actTd);

      entriesBody.appendChild(tr);
    });
}

/* Totaux */
function renderTotals() {
  const filtered = applyFilters(entries);
  const totalNet = filtered.reduce((s, e) => s + e.net, 0);
  totalGlobalEl.textContent = `${totalNet.toFixed(2)} kg`;
  entriesCountEl.textContent = filtered.length;

  const today = dateEl.value;
  const totalToday = filtered
    .filter(e => e.date === today)
    .reduce((s, e) => s + e.net, 0);
  totalTodayEl.textContent = `${totalToday.toFixed(2)} kg`;

  chartTotalEl.textContent = `Total : ${totalNet.toFixed(2)} kg`;
}

/* Graphique par type avec couleurs personnalis√©es */
function renderChart() {
  const filtered = applyFilters(entries);
  const byType = {};
  filtered.forEach(e => {
    byType[e.wasteType] = (byType[e.wasteType] || 0) + e.net;
  });

  const labels = Object.keys(byType);
  const data = labels.map(l => byType[l]);

  const COLORS_BY_TYPE = {
    "Alu Nu": "rgba(0, 128, 0, 0.8)",         // Vert
    "Isol√©": "rgba(0, 0, 255, 0.8)",           // Bleu
    "Arm√©": "rgba(255, 0, 0, 0.8)",            // Rouge
    "Alu Sous Plomb": "rgba(255, 255, 0, 0.8)", // Jaune
    "Ferraille": "rgba(128, 128, 128, 0.8)",   // Gris
    "D√©pouille PE": "rgba(255, 165, 0, 0.8)",  // Orange
    "D√©pouille PVC": "rgba(0, 0, 0, 0.8)",     // Noir
    "D√©pouille Plomb": "rgba(255, 255, 255, 0.8)",// Blanc
    "Purge PE": "rgba(57, 255, 20, 0.9)",      // Vert Fluo
    "Purge PVC": "rgba(255, 20, 147, 0.9)",    // Rose Fluo
    "Aiguillettes": "rgba(255, 105, 180, 0.8)" // Rose clair (par d√©faut si non sp√©cifi√©)
  };

  const ctx = document.getElementById("typeChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Poids net (kg)",
        data,
        borderRadius: 8,
        backgroundColor: labels.map(label => COLORS_BY_TYPE[label] || "rgba(255, 179, 0, 0.85)"), // Couleur par d√©faut si type inconnu
        borderColor: "rgba(0,0,0,0.4)",
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: "#a1a4c2", font: { size: 10 } }, grid: { display: false } },
        y: { ticks: { color: "#a1a4c2", font: { size: 10 } }, grid: { color: "rgba(255,255,255,0.08)" }, beginAtZero: true }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: "rgba(6,8,28,0.96)",
          borderColor: "rgba(255,255,255,0.2)",
          borderWidth: 1,
          titleColor: "#f7f7ff",
          bodyColor: "#f7f7ff",
          padding: 8,
          callbacks: { label: ctx => ` ${ctx.parsed.y.toFixed(2)} kg` }
        }
      }
    }
  });
}

/* Export CSV */
function exportCSV() {
  const filtered = applyFilters(entries);
  if (!filtered.length) {
    alert("Aucune donn√©e √† exporter avec les filtres actuels.");
    return;
  }

  const header = [
    "Date",
    "Secteur",
    "Type",
    "Benne/Big bag",
    "Poids brut (kg)",
    "Tare (kg)",
    "Poids net (kg)",
    "Commentaire"
  ];

  const rows = filtered.map(e => [
    e.date,
    e.sector,
    e.wasteType,
    e.containerLabel || e.containerId,
    e.gross.toFixed(2),
    e.tare.toFixed(2),
    e.net.toFixed(2),
    (e.comment || "").replace(/"/g, '""')
  ]);

  const csvLines = [
    header.join(";"),
    ...rows.map(r => r.map(v => `"${v}"`).join(";"))
  ];

  const blob = new Blob(["\uFEFF" + csvLines.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  a.download = `dechets_cablerie_${yyyy}${mm}${dd}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* Export Excel simple (XLS) */
function exportXLS() {
  const filtered = applyFilters(entries);
  if (!filtered.length) {
    alert("Aucune donn√©e √† exporter avec les filtres actuels.");
    return;
  }

  let tableHTML = `
    <table border="1">
      <tr>
        <th>Date</th>
        <th>Secteur</th>
        <th>Type</th>
        <th>Benne/Big bag</th>
        <th>Poids brut (kg)</th>
        <th>Tare (kg)</th>
        <th>Poids net (kg)</th>
        <th>Commentaire</th>
      </tr>
  `;

  filtered.forEach(e => {
    tableHTML += `
      <tr>
        <td>${e.date}</td>
        <td>${e.sector}</td>
        <td>${e.wasteType}</td>
        <td>${(e.containerLabel || e.containerId).replace(/</g, "&lt;")}</td>
        <td>${e.gross.toFixed(2)}</td>
        <td>${e.tare.toFixed(2)}</td>
        <td>${e.net.toFixed(2)}</td>
        <td>${(e.comment || "").replace(/</g, "&lt;").replace(/>/g, "&gt;")}</td>
      </tr>
    `;
  });

  tableHTML += "</table>";

  const blob = new Blob([tableHTML], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  a.download = `dechets_cablerie_${yyyy}${mm}${dd}.xls`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

exportCsvBtn.addEventListener("click", exportCSV);
exportXlsBtn.addEventListener("click", exportXLS);

/* Rendu global */
function renderAll() {
  renderTable();
  renderTotals();
  renderChart();
}

renderAll();
</script>
</body>
</html>
