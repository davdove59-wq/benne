<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Nexans ‚Äì Suivi des Bennes avec Console Admin Isol√©e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- jsPDF, AutoTable, svg2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@1.4.7/dist/svg2pdf.min.js"></script>

  <style>
    :root {
      --bg: #05060b;
      --bg-soft: #090b13;
      --accent: #ff4d4d;
      --accent-soft: rgba(255, 77, 77, 0.3);
      --accent-2: #ffd95a;
      --text: #f5f5f5;
      --muted: #9da3b4;
      --border-soft: rgba(255,255,255,0.07);
      --card-bg: rgba(10, 12, 22, 0.85);
      --radius-lg: 18px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
      --blur: 18px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at 0% 0%, #1d2035 0, #05060b 40%, #05060b 100%);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 10% 0%, rgba(255,77,77,0.16), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(68,198,255,0.18), transparent 55%);
      opacity: 0.8;
      mix-blend-mode: screen;
      z-index: -1;
    }

    main {
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 50px;
    }

    .logo-wrap {
      width: 120px;
      padding: 2px;
      flex-shrink: 0;
    }

    .logo-wrap img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    h1 {
      font-family: "Space Grotesk", system-ui;
      font-size: clamp(1.5rem, 2.4vw, 1.9rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 span.sub {
      font-size: 0.63em;
      font-weight: 400;
      color: var(--muted);
      letter-spacing: 0.16em;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.25), transparent 55%);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      box-shadow: 0 0 0 5px rgba(74,222,128,0.18);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 18px;
    }

    @media (max-width: 820px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-actions {
        align-items: flex-start;
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      padding: 16px 14px 16px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(255,77,77,0.08), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card-title {
      font-family: "Space Grotesk";
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .card-sub {
      font-size: 0.78rem;
      color: var(--muted);
    }

    label {
      display: block;
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    select,
    input[type="number"],
    input[type="text"],
    input[type="date"] {
      width: auto;
      min-width: 120px;
      max-width: 280px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(4,6,14,0.85);
      color: var(--text);
      padding: 9px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, transform 0.06s ease;
      display: block;
    }

    select:focus,
    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,77,77,0.55);
      background: rgba(6,10,22,0.95);
      transform: translateY(-0.5px);
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.6) 50%),
        linear-gradient(135deg, rgba(255,255,255,0.6) 50%, transparent 50%);
      background-position: calc(100% - 14px) 50%, calc(100% - 10px) 50%;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }

    .field-row {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 10px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.3), transparent 55%),
                  linear-gradient(135deg, #ff4d4d, #ff7a3c);
      color: #fff;
      padding: 9px 24px;
      font-size: 0.86rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.16);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease, background 0.2s ease;
      width: auto;
      max-width: 280px;
    }

    .btn-secondary {
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.22), transparent 55%),
                  linear-gradient(135deg, #151826, #262a3a);
      color: var(--text);
      border-color: rgba(255,255,255,0.22);
      box-shadow: 0 12px 26px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.12);
    }

    .btn-ghost {
      background: rgba(10,12,22,0.7);
      border: 1px dashed rgba(255,255,255,0.26);
      box-shadow: none;
      color: var(--muted);
    }

    .btn:hover {
      transform: translateY(-1px) scale(1.01);
      filter: brightness(1.03);
      box-shadow: 0 16px 36px rgba(0,0,0,0.85);
    }

    .btn:active {
      transform: translateY(0) scale(0.99);
      box-shadow: 0 6px 16px rgba(0,0,0,0.8);
      filter: brightness(0.97);
    }

    .muted {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .mt-8 { margin-top: 8px; }
    .mt-10 { margin-top: 10px; }
    .mt-14 { margin-top: 14px; }
    .mt-18 { margin-top: 18px; }

    .table-card {
      margin-top: 4px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .filters-group {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(8,10,20,0.9);
    }

    thead {
      background: linear-gradient(90deg, rgba(255,77,77,0.42), rgba(255,217,90,0.26));
    }

    th, td {
      padding: 7px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      white-space: nowrap;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.7rem;
    }

    tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.01);
    }

    tbody tr:hover {
      background: rgba(255,255,255,0.04);
    }

    .table-scroll {
      max-height: 320px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 0.7rem;
    }

    .badge-soft {
      background: rgba(255,217,90,0.16);
      border-color: rgba(255,217,90,0.36);
    }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .chart-box {
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.14), transparent 65%),
                  radial-gradient(circle at 100% 100%, rgba(68,198,255,0.14), transparent 65%);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 8px 8px 6px;
      position: relative;
      overflow: hidden;
    }

    .chart-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .chart-legend {
      display: none;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.65rem;
      color: var(--muted);
      background: rgba(5,6,15,0.9);
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(255,255,255,0.12);
      white-space: normal;
      max-width: 120px;
    }

    .legend-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    svg {
      width: 100%;
      height: 140px;
      display: block;
    }

    [data-animate] {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeUp 0.6s ease forwards;
    }

    [data-animate="1"] { animation-delay: 0.05s; }
    [data-animate="2"] { animation-delay: 0.12s; }
    [data-animate="3"] { animation-delay: 0.2s; }
    [data-animate="4"] { animation-delay: 0.28s; }

    @keyframes fadeUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mono {
      font-family: "Space Grotesk", system-ui, monospace;
      letter-spacing: 0.08em;
    }

    .small-note {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 4px;
    }

    #messageBox {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-family: "Space Grotesk", system-ui;
      box-shadow: 0 4px 12px rgba(255,77,77,0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
      user-select: none;
    }
    #messageBox.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Style pour la colonne supprimer */
    .delete-cell {
      text-align: center;
      cursor: pointer;
      color: #ff4d4d;
      font-weight: bold;
      user-select: none;
    }
    .delete-cell:hover {
      color: #ff0000;
    }

    /* Container Big Bags sous graphique type */
    #bigBagContainer {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    #bigBagContainer div {
      text-align: center;
      color: #ddd;
      font-size: 0.85rem;
      user-select: none;
    }
    #bigBagContainer img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 6px;
    }
    #bigBagContainer div > div {
      font-weight: 700;
      color: #ff4d4d;
    }
    #bigBagContainer .label {
      margin-bottom: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: #ddd;
      font-weight: 600;
    }
    #bigBagContainer .color-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      vertical-align: middle;
    }

    /* Button Hamburger */
    #adminToggleBtn {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 10000;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 28px;
      color: var(--accent);
      user-select: none;
      transition: color 0.3s ease;
    }
    #adminToggleBtn:hover {
      color: #ff7777;
    }

    /* === Console Admin isol√©e === */
    #adminPanel {
      all: initial;
      position: fixed;
      top: 0;
      right: -420px;
    /*  width: 400px;*/
      height: 100vh;
      background: var(--card-bg);
      box-shadow: -4px 0 12px rgba(0,0,0,0.7);
      transition: right 0.3s ease;
      z-index: 10001;
      overflow-y: auto;
      padding: 20px;
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
    }
    #adminPanel.open {
      right: 0;
    }

    #adminPanel h2 {
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      font-family: "Space Grotesk", system-ui;
      font-size: 1.4rem;
      color: var(--accent);
    }

    #adminPanel section {
      margin-bottom: 24px;
    }

    #adminPanel h3 {
      margin-bottom: 8px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding-bottom: 4px;
    }

    #adminPanel ul {
      list-style: none;
      padding: 0;
      margin: 0 0 12px 0;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius-md);
      background: rgba(5,6,15,0.9);
    }

    #adminPanel ul li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 0.85rem;
      cursor: default;
    }
    #adminPanel ul li:last-child {
      border-bottom: none;
    }

    #adminPanel ul li span.name {
      flex-grow: 1;
      user-select: text;
    }

    #adminPanel ul li button {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 1.1rem;
      margin-left: 8px;
      padding: 0;
      user-select: none;
      transition: color 0.2s ease;
    }
    #adminPanel ul li button:hover {
      color: #ff7777;
    }

    #adminPanel label {
      display: block;
      margin-top: 8px;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    #adminPanel input[type="text"],
    #adminPanel input[type="color"],
    #adminPanel select,
    #adminPanel input[type="number"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(4,6,14,0.85);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease;
      font-family: inherit;
    }
    #adminPanel input[type="text"]:focus,
    #adminPanel input[type="color"]:focus,
    #adminPanel select:focus,
    #adminPanel input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,77,77,0.55);
      background: rgba(6,10,22,0.95);
    }

    #adminPanel button.add-btn {
      margin-top: 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.3), transparent 55%),
                  linear-gradient(135deg, #ff4d4d, #ff7a3c);
      color: #fff;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease, filter 0.2s ease;
      width: 100%;
      font-family: inherit;
    }
    #adminPanel button.add-btn:hover {
      filter: brightness(1.1);
    }

    #binTypeSelect option {
      padding-left: 24px;
      background-repeat: no-repeat;
      background-position: 4px center;
      background-size: 16px 16px;
    }

    .bin-type-toggle {
      display: flex;
      gap: 10px;
      margin: 1em 0;
    }

    .bin-type-toggle label {
      cursor: pointer;
      user-select: none;
    }

    .bin-type-toggle input[type="radio"] {
      display: none;
    }

    .bin-type-toggle span {
      padding: 10px 20px;
      border: 2px solid #007bff;
      border-radius: 6px;
      color: #007bff;
      font-weight: 600;
      transition: background-color 0.3s, color 0.3s;
      display: inline-block;
    }

    .bin-type-toggle input[type="radio"]:checked + span {
      background-color: #007bff;
      color: white;
    }
/*PARTIE SAUVEGARDE/RESTAURATION*/
    .backup-restore-container {
      max-width: 320px;
      margin: 20px auto;
      padding: 15px 20px;
      background-color: rgba(4,6,14,0.85);
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 8px;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .separator-line {
      border: none;
      border-top: 2px solid #555;
      width: 50px;
      margin: 0 auto 10px auto;
    }

    .backup-restore-container h2 {
      margin: 0;
      padding-top: 10px;
      text-align: center;
      color: #4fc3f7;
      position: relative;
    }

    .backup-restore-container button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      background-color: #1976d2;
      border: none;
      color: white;
      transition: background-color 0.3s ease;
    }

    .backup-restore-container button:hover {
      background-color: #1565c0;
    }

    .btn-icon svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    #message {
      text-align: center;
      min-height: 1.2em;
      color: #81c784;
      font-weight: 600;
    }




  </style>

  <body>
    <button id="adminToggleBtn" aria-label="Ouvrir la console d'administration">&#9776;</button>

    <div id="adminPanel" role="dialog" aria-modal="true" tabindex="-1" inert>
      <button id="adminCloseBtn" aria-label="Fermer la console" style="font-size:24px; background:none; border:none; color:var(--accent); cursor:pointer; align-self:flex-end; margin-bottom:10px;">&times;</button>
      <h2>Console d'administration</h2>

      <section id="adminSectorsSection">
        <h3>Secteurs</h3>
        <ul id="sectorList"></ul>
        <input type="text" id="newSectorInput" placeholder="Nom du nouveau secteur" aria-label="Nom du nouveau secteur" />
        <button id="addSectorBtn" class="add-btn">Ajouter un secteur</button>
      </section>

      <section id="adminColorsSection">
        <h3>Couleurs par type de d√©chet</h3>
        <ul id="colorList"></ul>
        <input type="text" id="newColorTypeInput" placeholder="Nom du type de d√©chet" aria-label="Nom du type de d√©chet" />
        <input type="color" id="newColorInput" value="#ff4d4d" aria-label="S√©lecteur de couleur" />
        <button id="addColorBtn" class="add-btn">Ajouter une couleur</button>
      </section>

      <section id="adminBinsSection">
        <h3>Bennes</h3>
        <label for="binSectorSelect">Secteur :</label>
        <select id="binSectorSelect" aria-label="S√©lection secteur pour bennes"></select>
        <ul id="binList"></ul>
        <label for="binTypeSelect">Type de d√©chet :</label>
        <select id="binTypeSelect"></select>
        <div class="bin-type-toggle">
          <label>
            <input type="radio" name="binType" value="Benne" checked>
            <span>Benne</span>
          </label>
          <label>
            <input type="radio" name="binType" value="Big Bag">
            <span>Big Bag</span>
          </label>
        </div>
        <input type="number" id="newBinTareInput" placeholder="Tare (kg)" aria-label="Tare de la benne" min="0" step="1" />
        <button id="addBinBtn" class="add-btn">Ajouter une benne</button>

        <div class="backup-restore-container">
          <hr class="separator-line" />
          <h2>Sauvegarde et Restauration</h2>

          <button id="backupBtn" class="btn btn-primary">
            <span class="btn-icon" aria-hidden="true">
              <!-- Ic√¥ne cloud download -->
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4.406 12.342a.5.5 0 0 1 .708 0L7.5 14.728V5.5a.5.5 0 0 1 1 0v9.228l2.386-2.386a.5.5 0 1 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 0 1 0-.708z"/>
                <path d="M4.5 3a4.5 4.5 0 0 1 8.9 1.757A3.5 3.5 0 0 1 12 9H4a3 3 0 0 1 .5-6z"/>
              </svg>
            </span>
            Sauvegarder
          </button>

          <input type="file" id="restoreFileInput" accept=".json" style="display:none;" />
          <button id="selectFileBtn" class="btn btn-primary">
            <span class="btn-icon" aria-hidden="true">
              <!-- Ic√¥ne cloud upload -->
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4.406 3.658a.5.5 0 0 1 .708 0L7.5 6.544V1.5a.5.5 0 0 1 1 0v5.044l2.386-2.386a.5.5 0 1 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 0 1 0-.708z"/>
                <path d="M4.5 13a4.5 4.5 0 0 1 8.9-1.757A3.5 3.5 0 0 1 12 7H4a3 3 0 0 1 .5 6z"/>
              </svg>
            </span>
            Choisir un fichier
          </button>

          <button id="restoreBtn" class="btn btn-primary">
            <span class="btn-icon" aria-hidden="true">
              <!-- Ic√¥ne refresh -->
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 1v3h3"/>
              </svg>
            </span>
            Restaurer
          </button>

          <div id="message"></div>
        </div>

      </section>
    </div>

    

<div id="message" style="margin-top: 1em; color: green;"></div>


    <main>
  <header data-animate="1">
    <div class="brand">
      <div class="logo-wrap">
        <img src="logo-nexans-B.png" alt="Logo Nexans" />
      </div>
      <div>
        <h1>
          Suivi des Bennes
          <span class="sub">C√¢blerie ‚Äì Pes√©es & D√©chets</span>
        </h1>
      </div>
    </div>
    <div class="header-actions">
      <div class="chip">
        <span class="chip-dot"></span>
        <span>Mode local</span>
      </div>
      <span class="muted">Donn√©es stock√©es dans ce navigateur uniquement.</span>
    </div>
  </header>

  <section class="layout">
    <section class="card" data-animate="2">
      <div class="card-inner">
        <div class="card-header">
          <div>
            <div class="card-title">Nouvelle pes√©e</div>
            <div class="card-sub">S√©lectionner secteur, benne, puis saisir le poids brut.</div>
          </div>
          <span class="badge badge-soft mono">STEP ‚Ä¢ 1</span>
        </div>

        <form id="weightForm" autocomplete="off">
          <div class="mt-8">
            <label for="sector">Secteur</label>
            <select id="sector" required></select>
          </div>

          <div class="mt-8">
            <label for="bin">Benne / Big Bag</label>
            <select id="bin" required>
              <option value="">S√©lectionner un secteur d'abord</option>
            </select>
          </div>

          <div class="mt-8">
            <label for="bigContainer">Grande benne de destination</label>
            <input type="text" id="bigContainer" placeholder="Ex : C127 / Benne PVC" />
            <div class="small-note">
              Saisissez ici l'identit√© de la grande benne dans laquelle vous videz (modifiable √† chaque pes√©e).
            </div>
          </div>

          <div class="field-row mt-10">
            <div>
              <label for="tareWeight">Tare (kg)</label>
              <input type="number" id="tareWeight" readonly />
            </div>
            <div>
              <label for="grossWeight">Poids brut (kg)</label>
              <input type="number" id="grossWeight" required min="0" step="0.01" inputmode="decimal" />
            </div>
          </div>

          <div class="mt-8">
            <label for="netWeight">Poids net (kg)</label>
            <input type="number" id="netWeight" readonly />
          </div>

          <div style="margin-top: 12px; text-align: center;">
            <button type="submit" class="btn" aria-label="Enregistrer la pes√©e">
              ‚è∫ Enregistrer la pes√©e
            </button>
          </div>

          <div style="margin-top: 12px; text-align: center;">
            <button id="exportPdfBtn" class="btn btn-secondary" type="button" aria-label="Exporter la page en PDF">
              üìÑ Exporter en PDF
            </button>
            <p class="small-note" style="margin-top:6px; max-width: 320px; margin-left:auto; margin-right:auto;">
              G√©n√®re un PDF avec le texte NEXANS, le tableau et les graphiques int√©gr√©s.
            </p>
          </div>
        </form>

        <p class="small-note mt-8">
          Astuce : ajoutez cette page √† l'√©cran d'accueil sur iPhone pour l'utiliser comme une application.
        </p>
      </div>
    </section>

    <section class="card" data-animate="3">
      <div class="card-inner">
        <div class="card-header">
          <div>
            <div class="card-title">Synth√®se graphique</div>
            <div class="card-sub">Total des poids nets par secteur et par type de d√©chets.</div>
          </div>
          <span class="badge mono">LIVE</span>
        </div>

        <div class="chart-grid">
          <div class="chart-box">
            <div class="chart-title">
              <span>Poids par secteur</span>
              <div class="chart-legend" id="legendSector"></div>
            </div>
            <svg id="chartSector" role="img" aria-label="Histogramme des poids par secteur"></svg>
          </div>

          <div class="chart-box">
            <div class="chart-title">
              <span>Poids par type de d√©chets</span>
              <div class="chart-legend" id="legendType"></div>
            </div>
            <svg id="chartType" role="img" aria-label="Histogramme des poids par type de d√©chets"></svg>
            <div id="bigBagContainer"></div>
          </div>
        </div>

        <p class="small-note mt-8">
          Les graphiques se mettent √† jour automatiquement √† chaque nouvelle pes√©e.
        </p>
      </div>
    </section>
  </section>

  <section class="card table-card mt-18" data-animate="4">
    <div class="card-inner">
      <div class="card-header">
        <div>
          <div class="card-title">Historique des pes√©es</div>
          <div class="card-sub">Filtrer, copier ou exporter les donn√©es.</div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button id="copyTextBtn" class="btn btn-ghost" type="button" aria-label="Copier le texte de l'historique">
            üìã Copier texte
          </button>
          <button id="exportTextBtn" class="btn btn-secondary" type="button" aria-label="Exporter l'historique en fichier texte">
            ‚¨á Export texte + graphiques
          </button>
        </div>
      </div>

      <div class="filters">
        <div class="filters-group">
          <label for="filterFrom">Du</label>
          <input type="date" id="filterFrom" />
        </div>
        <div class="filters-group">
          <label for="filterTo">Au</label>
          <input type="date" id="filterTo" />
        </div>
        <div class="filters-group">
          <label for="filterSector">Secteur</label>
          <select id="filterSector">
            <option value="">Tous les secteurs</option>
          </select>
        </div>
        <div class="filters-group">
          <label for="filterType">Type</label>
          <select id="filterType">
            <option value="">Tous les types</option>
          </select>
        </div>
      </div>

      <div class="table-scroll" tabindex="0" aria-label="Tableau historique des pes√©es">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Secteur</th>
              <th>Benne</th>
              <th>Type</th>
              <th>Grande benne</th>
              <th>Tare</th>
              <th>Brut</th>
              <th>Net</th>
              <th>Supprimer</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small-note mt-8">
        La date est enregistr√©e (format : JJ/MM/AAAA). L'export "texte + graphiques" produit
        un bloc de texte brut que vous pouvez coller dans un document ou un logiciel de g√©n√©ration de PDF.
      </p>
    </div>
  </section>
</main>
    <div id="messageBox" role="alert" aria-live="polite" style="
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-family: 'Space Grotesk', system-ui;
      box-shadow: 0 4px 12px rgba(255,77,77,0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
      user-select: none;
    "></div>

    <script>
  // Variables globales pour secteurs et couleurs (charg√©es/sauvegard√©es localStorage)
  const LS_SECTORS = 'nexans_sectors';
  const LS_COLORS = 'nexans_colors';
  const STORAGE_KEY = 'weightHistory_v1';

  // Donn√©es par d√©faut
  const defaultSectors = {
      "Tr√©filage": [
    { type: "Benne", name: "Alu Nu", tare: 194, label: "Alu Nu ‚Äì 194 kg" },
    { type: "Benne", name:"Feraille", tare: 553, label: "Ferraille ‚Äì 553 kg" },
    { type: "Big Bag", name:"Aiguillettes",tare: 0, label: "Big Bag Aiguillettes" }
  ],
  "530": [
    { type: "Benne", name:"Alu Nu",tare: 160, label: "Alu Nu ‚Äì 160 kg" }
  ],
  "118": [
    { type: "Benne", name:"Alu Nu", tare: 160, label: "Alu Nu ‚Äì 160 kg" }
  ],
  "Bagger": [
    { type: "Benne", name:"Alu Nu", tare: 155, label: "Alu Nu ‚Äì 155 kg" }
  ],
  "RL": [
    { type: "Benne", name:"Alu Nu", tare: 198, label: "Alu Nu ‚Äì 198 kg" },
    { type: "Benne", name:"Arm√©", tare: 198, label: "Arm√© ‚Äì 198 kg" }
  ],
  "Bema": [
    { type: "Benne", name:"Alu Nu", tare: 120, label: "Alu Nu ‚Äì 120 kg" }
  ],
  "Presse √† Plomb": [
    { type: "Benne", name:"Arm√©", tare: 214, label: "Arm√© ‚Äì 214 kg" },
    { type: "Benne", name:"Alu Sous Plomb", tare: 216, label: "Alu Sous Plomb ‚Äì 216 kg" }
  ],
  "Sket": [
    { type: "Benne", name:"Alu Nu", tare: 141, label: "Alu Nu ‚Äì 141 kg" },
    { type: "Benne", name:"Alu Nu", tare: 146, label: "Alu Nu ‚Äì 146 kg" },
    { type: "Benne", name:"Alu Nu", tare: 136, label: "Alu Nu ‚Äì 136 kg" },
    { type: "Benne", name:"Alu Nu", tare: 200, label: "Alu Nu ‚Äì 200 kg" }
  ],
  "158": [
    { type: "Benne", name:"Alu Nu", tare: 212, label: "Alu Nu ‚Äì 212 kg" },
    { type: "Benne", name:"Isol√©", tare: 194, label: "Isol√© ‚Äì 194 kg" },
    { type: "Benne", name:"Alu Sous Plomb", tare: 220, label: "Alu Sous Plomb ‚Äì 220 kg" },
    { type: "Benne", name:"Feraille", tare: 196, label: "Ferraille ‚Äì 196 kg" },
    { type: "Benne", name:"Arm√©", tare: 198, label: "Arm√© ‚Äì 198 kg" }
  ],
  "Mono": [
    { type: "Benne", name:"Alu Nu", tare: 560, label: "Alu Nu ‚Äì 560 kg" },
    { type: "Benne", name:"Isol√©", tare: 202, label: "Isol√© ‚Äì 202 kg" },
    { type: "Big Bag", name:"Purge PE", tare: 0, label: "Big Bag Purge PE" }
  ],
  "153/156": [
    { type: "Benne", name:"Alu Nu", tare: 194, label: "Alu Nu ‚Äì 194 kg" },
    { type: "Benne", name:"Alu Sous Plomb", tare: 230, label: "Alu Sous Plomb ‚Äì 230 kg" },
    { type: "Benne", name:"Isol√©", tare: 160, label: "Isol√© ‚Äì 160 kg" },
    { type: "Benne", name:"Feraille", tare: 196, label: "Ferraille ‚Äì 196 kg" }
  ],
  "153": [
    { type: "Benne", name:"Feraille", tare: 160, label: "Ferraille ‚Äì 160 kg" }
  ],
  "156": [
    { type: "Benne", name:"Feraille", tare: 160, label: "Ferraille ‚Äì 160 kg" }
  ],
  "Maintenance": [
    { type: "Benne", name:"Feraille", tare: 240, label: "Ferraille ‚Äì 240 kg" }
  ],
  "7712": [
    { type: "Benne", name: "D√©pouille PE", tare: 146, label: "D√©pouille PE ‚Äì 146 kg" },
    { type: "Benne", name: "D√©pouille PE", tare: 147, label: "D√©pouille PE ‚Äì 147 kg" },
    { type: "Benne", name: "D√©pouille PE", tare: 143, label: "D√©pouille PE ‚Äì 143 kg" },
    { type: "Benne", name: "D√©pouille PVC", tare: 146, label: "D√©pouille PVC ‚Äì 146 kg" },
    { type: "Benne", name: "D√©pouille PVC", tare: 147, label: "D√©pouille PVC ‚Äì 147 kg" },
    { type: "Benne", name: "D√©pouille PVC", tare: 143, label: "D√©pouille PVC ‚Äì 143 kg" },
    { type: "Benne", name: "D√©pouille PVC", tare: 600, label: "D√©pouille PVC ‚Äì 600 kg" }
  ],
  "108": [
    { type: "Benne", name:"Isol√©", tare: 194, label: "Isol√© ‚Äì 194 kg" },
    { type: "Benne", name:"Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" }
  ],
  "Labo": [
    { type: "Benne", name:"Arm√©", tare: 194, label: "Arm√© ‚Äì 194 kg" },
    { type: "Benne", name:"Alu Nu", tare: 196, label: "Alu Nu ‚Äì 196 kg" }
  ],
  "PCV4": [
    { type: "Benne", name:"Isol√©", tare: 164, label: "Isol√© ‚Äì 164 kg" },
    { type: "Benne", name:"Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" }
  ],
  "PCV3": [
    { type: "Benne", name:"Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" },
    { type: "Benne", name:"Arm√©", tare: 164, label: "Arm√© ‚Äì 164 kg" }
  ],
  "Cellules": [
    { type: "Benne", name:"Feraille", tare: 160, label: "Ferraille ‚Äì 160 kg" },
    { type: "Benne", name: "D√©pouille PVC", tare: 160, label: "D√©pouille PVC ‚Äì 160 kg" },
    { type: "Benne", name:"Isol√©", tare: 160, label: "Isol√© ‚Äì 160 kg" },
    { type: "Benne", name:"Alu Nu", tare: 160, label: "Alu Nu ‚Äì 160 kg" },
    { type: "Benne", name:"Alu Sous Plomb", tare: 160, label: "Alu Sous Plomb ‚Äì 160 kg" }
  ],
  "PCV": [
    { type: "Benne", name:"Arm√©", tare: 200, label: "Arm√© ‚Äì 200 kg" },
    { type: "Benne", name:"Isol√©", tare: 200, label: "Isol√© ‚Äì 200 kg" },
    { type: "Benne", name:"Alu Nu", tare: 200, label: "Alu Nu ‚Äì 200 kg" },
    { type: "Big Bag", name:"Purge PVC", tare: 0, label: "Big Bag Purge PVC" }
  ],
  "Couronneuse": [
    { type: "Benne", name:"Arm√©", tare: 400, label: "Arm√© ‚Äì 400 kg" },
    { type: "Benne", name:"Arm√©", tare: 98, label: "Arm√© ‚Äì 98 kg" }
  ],
  "Brondel": [
    { type: "Benne", name:"Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" },
    { type: "Benne", name:"Isol√©", tare: 160, label: "Isol√© ‚Äì 160 kg" },
    { type: "Benne", name:"Isol√©", tare: 536, label: "Isol√© ‚Äì 536 kg" }
  ],
  "Cisaille": [
    { type: "Benne", name:"Arm√©", tare: 160, label: "Arm√© ‚Äì 160 kg" },
    { type: "Benne", name:"Isol√©", tare: 164, label: "Isol√© ‚Äì 164 kg" },
    { type: "Benne", name:"Alu Nu", tare: 164, label: "Alu Nu ‚Äì 164 kg" },
    { type: "Benne", name:"Alu Sous Plomb", tare: 160, label: "Alu Sous Plomb ‚Äì 160 kg" }
  ]
  };

  const defaultColorsByType = {
    "Alu Nu": "rgba(0, 128, 0, 0.8)",
    "Isol√©": "rgba(0, 0, 255, 0.8)",
    "Arm√©": "rgba(255, 0, 0, 0.8)",
    "Alu Sous Plomb": "rgba(255, 255, 0, 0.8)",
    "Ferraille": "rgba(128, 128, 128, 0.8)",
    "D√©pouille PE": "rgba(255, 165, 0, 0.8)",
    "D√©pouille PVC": "rgba(0, 0, 0, 0.8)",
    "D√©pouille Plomb": "rgba(255, 255, 255, 0.8)",
    "Purge PE": "rgba(57, 255, 20, 0.9)",
    "Purge PVC": "rgba(255, 20, 147, 0.9)",
    "Aiguillettes": "rgba(255, 105, 180, 0.8)"
  };

  // Chargement/sauvegarde localStorage
  function loadSectors() {
    const ls = localStorage.getItem(LS_SECTORS);
    if (ls) {
      try { return JSON.parse(ls); } catch { return {...defaultSectors}; }
    }
    return {...defaultSectors};
  }
  function saveSectors(data) {
    localStorage.setItem('nexans_sectors', JSON.stringify(data));
  }
  function loadColors() {
    const ls = localStorage.getItem(LS_COLORS);
    if (ls) {
      try { return JSON.parse(ls); } catch { return {...defaultColorsByType}; }
    }
    return {...defaultColorsByType};
  }
  function saveColors(data) {
    localStorage.setItem(LS_COLORS, JSON.stringify(data));
  }
  function loadHistory() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    } catch {
      return [];
    }
  }
  function saveHistory(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // Variables globales (doit √™tre initialis√©e avant)
  let sectors = loadSectors();
  let colorsByType = loadColors();// Charge depuis localStorage ou valeurs par d√©faut

  // DOM references
  const adminToggleBtn = document.getElementById('adminToggleBtn');
  const adminCloseBtn = document.getElementById('adminCloseBtn');
  const adminPanel = document.getElementById('adminPanel');

  const sectorList = document.getElementById('sectorList');
  const newSectorInput = document.getElementById('newSectorInput');
  const addSectorBtn = document.getElementById('addSectorBtn');

  const colorList = document.getElementById('colorList');
  const newColorTypeInput = document.getElementById('newColorTypeInput');
  const newColorInput = document.getElementById('newColorInput');
  const addColorBtn = document.getElementById('addColorBtn');
  const binSectorSelect = document.getElementById('binSectorSelect');
  
  const binList = document.getElementById('binList');
  const newBinNameInput = document.getElementById('newBinNameInput');
  const newBinTypeInput = document.getElementById('newBinTypeInput');
  const newBinTareInput = document.getElementById('newBinTareInput');
  const addBinBtn = document.getElementById('addBinBtn');

  const sectorSelect = document.getElementById('sector');
  const binSelect = document.getElementById('bin');
  const binTypeSelect = document.getElementById('binTypeSelect');
  const tareWeightInput = document.getElementById('tareWeight');
  const grossWeightInput = document.getElementById('grossWeight');
  const netWeightInput = document.getElementById('netWeight');
  const bigContainerInput = document.getElementById('bigContainer');
  const weightForm = document.getElementById('weightForm');

  const historyTableBody = document.querySelector('#historyTable tbody');
  const filterSector = document.getElementById('filterSector');
  const filterType = document.getElementById('filterType');
  const filterFrom = document.getElementById('filterFrom');
  const filterTo = document.getElementById('filterTo');

  const copyTextBtn = document.getElementById('copyTextBtn');
  const exportTextBtn = document.getElementById('exportTextBtn');
  const exportPdfBtn = document.getElementById('exportPdfBtn');

  const chartSectorSvg = document.getElementById('chartSector');
  const chartTypeSvg = document.getElementById('chartType');
  const legendSector = document.getElementById('legendSector');
  const legendType = document.getElementById('legendType');

  const messageBox = document.getElementById('messageBox');

  // Helper functions
  function showMessage(text, duration = 1500) {
    messageBox.textContent = text;
    messageBox.style.opacity = '1';
    messageBox.style.pointerEvents = 'auto';
    setTimeout(() => {
      messageBox.style.opacity = '0';
      messageBox.style.pointerEvents = 'none';
    }, duration);
  }

  function rgbaToHex(rgba) {
    if (rgba.startsWith('#')) return rgba;
    const parts = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if (!parts) return '#000000';
    const r = parseInt(parts[1]).toString(16).padStart(2, '0');
    const g = parseInt(parts[2]).toString(16).padStart(2, '0');
    const b = parseInt(parts[3]).toString(16).padStart(2, '0');
    return `#${r}${g}${b}`;
  }

  // Admin panel open/close using inert attribute for accessibility
  adminToggleBtn.addEventListener('click', () => {
    adminPanel.inert = false;
    adminPanel.classList.add('open');
    adminPanel.focus();
  });
  adminCloseBtn.addEventListener('click', () => {
    adminPanel.inert = true;
    adminPanel.classList.remove('open');
  });

  // Render admin lists
  function renderSectorList() {
    sectorList.innerHTML = '';
    Object.keys(sectors).sort((a,b) => a.localeCompare(b)).forEach(sec => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="name">${sec}</span>
        <button aria-label="Supprimer secteur ${sec}" title="Supprimer secteur">üóëÔ∏è</button>`;
      li.querySelector('button').addEventListener('click', () => {
        if (confirm(`Supprimer le secteur "${sec}" et toutes ses bennes ?`)) {
          delete sectors[sec];
          saveSectors(sectors);
          renderSectorList();
          renderBinSectorSelect();
          refreshSectorSelects();
          refreshFiltersTypes();
          renderTable();
          refreshCharts();
        }
      });
      sectorList.appendChild(li);
    });
  }

  function renderColorList() {
    colorList.innerHTML = '';
    Object.keys(colorsByType).sort((a,b) => a.localeCompare(b)).forEach(type => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="name">${type}</span>
        <input type="color" value="${rgbaToHex(colorsByType[type])}" aria-label="Couleur pour ${type}" />
        <button aria-label="Supprimer couleur ${type}" title="Supprimer couleur">üóëÔ∏è</button>`;
      const inputColor = li.querySelector('input');
      inputColor.addEventListener('input', e => {
        colorsByType[type] = e.target.value;
        saveColors(colorsByType);
        refreshCharts();
      });
      li.querySelector('button').addEventListener('click', () => {
        if (confirm(`Supprimer la couleur pour "${type}" ?`)) {
          delete colorsByType[type];
          saveColors(colorsByType);
          renderColorList();
          refreshCharts();
        }
      });
      colorList.appendChild(li);
    });
  }

  function renderBinSectorSelect() {
    binSectorSelect.innerHTML = '';
    Object.keys(sectors).sort((a,b) => a.localeCompare(b)).forEach(sec => {
      const opt = document.createElement('option');
      opt.value = sec;
      opt.textContent = sec;
      binSectorSelect.appendChild(opt);
    });
    if (binSectorSelect.options.length > 0) {
      binSectorSelect.value = binSectorSelect.options[0].value;
      renderBinList(binSectorSelect.value);
    } else {
      binList.innerHTML = '';
    }
  }

// Fonction pour afficher les bennes du secteur s√©lectionn√©
function renderBinList(sector) {
  binList.innerHTML = '';
  if (!sectors[sector]) return;
  sectors[sector].forEach((bin, idx) => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="name">${bin.type} : ${bin.name} (Tare: ${bin.tare} kg)</span>
      <button aria-label="Supprimer benne ${bin.name}" title="Supprimer benne">üóëÔ∏è</button>`;
    li.querySelector('button').addEventListener('click', () => {
      if (confirm(`Supprimer la benne "${bin.name}" du secteur "${sector}" ?`)) {
        sectors[sector].splice(idx, 1);
        saveSectors(sectors);
        renderBinList(sector);
        refreshSectorSelects();
        refreshFiltersTypes();
        renderTable();
        refreshCharts();
      }
    });
    binList.appendChild(li);
  });
}

  // Fonction pour rafra√Æchir les selects secteur dans formulaire principal et filtres
function refreshSectorSelects() {
  const sectorSelect = document.getElementById('sector');
  const filterSector = document.getElementById('filterSector');
  sectorSelect.innerHTML = '<option value="">S√©lectionner un secteur</option>';
  filterSector.innerHTML = '<option value="">Tous les secteurs</option>';
  Object.keys(sectors).sort().forEach(sec => {
    const opt1 = document.createElement('option');
    opt1.value = sec;
    opt1.textContent = sec;
    sectorSelect.appendChild(opt1);
    const opt2 = document.createElement('option');
    opt2.value = sec;
    opt2.textContent = sec;
    filterSector.appendChild(opt2);
  });
}

function refreshFiltersTypes() {
  // S√©lecteur du filtre dans votre interface (√† adapter si besoin)
  const filterTypeSelect = document.getElementById('filterTypeSelect');
  if (!filterTypeSelect) return;

  // Vider le filtre existant
  filterTypeSelect.innerHTML = '';

  // Ajouter une option "Tous les types" par d√©faut
  const allOption = document.createElement('option');
  allOption.value = '';
  allOption.textContent = 'Tous les types';
  filterTypeSelect.appendChild(allOption);

  // Ajouter les options pour chaque type de d√©chet tri√© alphab√©tiquement
  Object.keys(defaultColorsByType).sort().forEach(type => {
    const option = document.createElement('option');
    option.value = type;
    option.textContent = type;
    filterTypeSelect.appendChild(option);
  });
}


// √âv√©nement changement secteur dans console admin
binSectorSelect.addEventListener('change', () => {
  const selectedSector = binSectorSelect.value;
  renderBinList(selectedSector);
});

// Fonction pour rafra√Æchir le select secteur dans la console admin pour bennes
function renderBinSectorSelect() {
  const binSectorSelect = document.getElementById('binSectorSelect');
  binSectorSelect.innerHTML = '';
  Object.keys(sectors).sort().forEach(sec => {
    const opt = document.createElement('option');
    opt.value = sec;
    opt.textContent = sec;
    binSectorSelect.appendChild(opt);
  });
  if (binSectorSelect.options.length > 0) {
    binSectorSelect.value = binSectorSelect.options[0].value;
    renderBinList(binSectorSelect.value);
  } else {
    const binList = document.getElementById('binList');
    binList.innerHTML = '';
  }
}

// √âv√©nement clic bouton ajouter secteur
addSectorBtn.addEventListener('click', () => {
  const val = newSectorInput.value.trim();
  if (!val) {
    alert('Entrez un nom de secteur.');
    return;
  }
  if (sectors[val]) {
    alert('Secteur d√©j√† existant.');
    return;
  }
  sectors[val] = [];
  saveSectors(sectors);
  newSectorInput.value = '';
  renderSectorList();
  renderBinSectorSelect();
  refreshSectorSelects();
  refreshFiltersTypes();
  renderTable();
  refreshCharts();
  showMessage(`Secteur "${val}" ajout√©.`);
});

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
  sectors = loadSectors();
  renderSectorList();
  renderBinSectorSelect();
  refreshSectorSelects();
});


// Fonction de sauvegarde couleurs
function saveColors(data) {
  localStorage.setItem('nexans_colors', JSON.stringify(data));
}

// Fonction pour afficher la liste des couleurs dans la console admin
function renderColorList() {
  colorList.innerHTML = '';
  Object.entries(colorsByType).sort((a, b) => a[0].localeCompare(b[0])).forEach(([type, color]) => {
    const li = document.createElement('li');
    li.innerHTML = `
      <span class="name">${type}</span> 
      <span class="color-swatch" style="
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-left: 8px;
        vertical-align: middle;
        border: 1px solid #ccc;
        background-color: ${color};
        border-radius: 3px;
      "></span>
      <button aria-label="Supprimer couleur ${type}" title="Supprimer couleur">üóëÔ∏è</button>
    `;
    li.querySelector('button').addEventListener('click', () => {
      if (confirm(`Supprimer la couleur du type "${type}" ?`)) {
        delete colorsByType[type];
        saveColors(colorsByType);
        renderColorList();
        refreshCharts();
      }
    });
    colorList.appendChild(li);
  });
}

// √âv√©nement clic bouton ajouter couleur
addColorBtn.addEventListener('click', () => {
  const type = newColorTypeInput.value.trim();
  const color = newColorInput.value.trim();

  if (!type) {
    alert('Veuillez saisir un nom de type.');
    return;
  }
  if (!color) {
    alert('Veuillez saisir une couleur.');
    return;
  }
  // Optionnel : valider que color est une couleur CSS valide (ex: #rrggbb ou rgba(...))
  // Ici on fait simple

  if (colorsByType[type]) {
    alert('Ce type a d√©j√† une couleur d√©finie.');
    return;
  }

  colorsByType[type] = color;
  saveColors(colorsByType);

  newColorTypeInput.value = '';
  newColorInput.value = '';

  renderColorList();
  refreshCharts();

  showMessage(`Couleur ajout√©e pour le type "${type}".`);
});

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
  colorsByType = loadColors();
  renderColorList();
});



// Fonction d‚Äôajout benne
// Remplir la liste d√©roulante des types de d√©chets avec pastilles couleur
function populateBinTypeSelect() {
  const binTypeSelect = document.getElementById('binTypeSelect');
  binTypeSelect.innerHTML = '';
  Object.entries(defaultColorsByType).sort((a, b) => a[0].localeCompare(b[0])).forEach(([type, color]) => {
    const option = document.createElement('option');
    option.value = type;
    option.textContent = type;
    option.setAttribute('data-color', color);
    binTypeSelect.appendChild(option);
  });
  applyColorsToOptions();
}

function applyColorsToOptions() {
  const binTypeSelect = document.getElementById('binTypeSelect');
  Array.from(binTypeSelect.options).forEach(option => {
    const color = option.getAttribute('data-color');
    if (color) {
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16">
        <rect width="16" height="16" fill="${color}" rx="3" ry="3"/>
      </svg>`;
      const encoded = encodeURIComponent(svg).replace(/'/g, "%27").replace(/"/g, "%22");
      const dataUrl = `url("data:image/svg+xml,${encoded}")`;
      option.style.backgroundImage = dataUrl;
    }
  });
}


document.addEventListener('DOMContentLoaded', () => {
  populateBinTypeSelect();
});




// Fonction d‚Äôajout benne adapt√©e
addBinBtn.addEventListener('click', () => {
  const sector = binSectorSelect.value;
  const name = binTypeSelect.value.trim(); // Type de d√©chet s√©lectionn√©
  const type = document.querySelector('input[name="binType"]:checked').value;
  const tare = parseInt(newBinTareInput.value, 10);

  if (!sector) {
    alert('Veuillez s√©lectionner un secteur.');
    return;
  }
  if (!name) {
    alert('Veuillez s√©lectionner un type de d√©chet.');
    return;
  }
  if (!type || (type !== 'Benne' && type !== 'Big Bag')) {
    alert('Le type doit √™tre "Benne" ou "Big Bag".');
    return;
  }
  if (isNaN(tare) || tare < 0) {
    alert('La tare doit √™tre un nombre entier positif.');
    return;
  }

  // V√©rifier si la benne existe d√©j√† dans ce secteur (m√™me nom et type)
  const exists = sectors[sector].some(bin => bin.name === name && bin.type === type);
  if (exists) {
    alert('Cette benne existe d√©j√† dans ce secteur.');
    return;
  }

  // Ajouter la benne
  sectors[sector].push({ type, name, tare, label: `${type} ${name} ‚Äì ${tare} kg` });
  saveSectors(sectors);

  // R√©initialisation des champs apr√®s ajout r√©ussi
  binSectorSelect.value = '';
  binTypeSelect.value = '';
  newBinTareInput.value = '';
  document.querySelector('input[name="binType"][value="Benne"]').checked = true; // remet "Benne" s√©lectionn√© par d√©faut

  // Rafra√Æchir affichages
  renderBinList(sector);
  refreshSectorSelects();
  refreshFiltersTypes();
  renderTable();
  refreshCharts();

  showMessage(`Benne "${name}" ajout√©e au secteur "${sector}".`);
});

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
  populateBinTypeSelect();
  applyColorsToOptions();
  sectors = loadSectors();
});

  // Populate secteurs dans formulaire principal
  function populateSectors() {
    refreshSectorSelects();
  }

 // Ouvre la bo√Æte de dialogue fichier quand on clique sur le bouton "Choisir un fichier"
document.getElementById('selectFileBtn').addEventListener('click', () => {
  document.getElementById('restoreFileInput').click();
});

// Affiche le nom du fichier s√©lectionn√© dans le message (optionnel)
document.getElementById('restoreFileInput').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    document.getElementById('message').textContent = `Fichier s√©lectionn√© : ${file.name}`;
  }
});

// Sauvegarde du LocalStorage dans un fichier JSON
document.getElementById('backupBtn').addEventListener('click', () => {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    data[key] = localStorage.getItem(key);
  }
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'localstorage-backup.json';
  a.click();
  URL.revokeObjectURL(url);
  document.getElementById('message').textContent = 'Sauvegarde effectu√©e.';
});

// Restauration du LocalStorage depuis un fichier JSON
document.getElementById('restoreBtn').addEventListener('click', () => {
  const fileInput = document.getElementById('restoreFileInput');
  const file = fileInput.files[0];
  if (!file) {
    alert('Veuillez choisir un fichier avant de restaurer.');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      localStorage.clear();
      for (const key in data) {
        if (data.hasOwnProperty(key)) {
          localStorage.setItem(key, data[key]);
        }
      }
      document.getElementById('message').textContent = 'Restauration r√©ussie.';
      // Ici, appelez vos fonctions pour rafra√Æchir l‚Äôinterface si besoin
    } catch (err) {
      alert('Fichier invalide ou corrompu.');
    }
  };
  reader.readAsText(file);
});





  // Populate bennes selon secteur s√©lectionn√©
  function populateBins() {
    binSelect.innerHTML = '<option value="">S√©lectionner une benne</option>';
    tareWeightInput.value = '';
    netWeightInput.value = '';
    grossWeightInput.value = '';

    const sec = sectorSelect.value;
    if (!sec || !sectors[sec]) return;

    sectors[sec].forEach((bin, index) => {
      const opt = document.createElement('option');
      opt.value = index;
      opt.textContent = `${bin.type} : ${bin.name} (Tare: ${bin.tare} kg)`;
      binSelect.appendChild(opt);
    });
  }

  // Mise √† jour tare selon benne s√©lectionn√©e
  function updateTare() {
    const sec = sectorSelect.value;
    const idx = binSelect.value;
    if (sec && idx !== "" && sectors[sec]) {
      const tare = sectors[sec][idx].tare;
      tareWeightInput.value = tare;
    } else {
      tareWeightInput.value = '';
    }
    calculateNetWeight();
  }

  // Calcul poids net
  function calculateNetWeight() {
    const gross = parseFloat(grossWeightInput.value) || 0;
    const tare = parseFloat(tareWeightInput.value) || 0;
    netWeightInput.value = gross > tare ? (gross - tare).toFixed(2) : 0;
  }

  // Filtrage historique
  function getFilteredHistory() {
    const history = loadHistory();
    const secFilter = filterSector.value;
    const typeFilter = filterType.value;
    const from = filterFrom.value ? new Date(filterFrom.value + 'T00:00:00') : null;
    const to = filterTo.value ? new Date(filterTo.value + 'T23:59:59') : null;

    return history.filter(entry => {
      if (secFilter && entry.sector !== secFilter) return false;
      if (typeFilter && entry.binType !== typeFilter) return false;

      if (from || to) {
        const d = new Date(entry.date);
        if (from && d < from) return false;
        if (to && d > to) return false;
      }

      return true;
    });
  }

  // Rendu tableau historique
  function renderTable() {
    const rows = getFilteredHistory();
    historyTableBody.innerHTML = '';
    rows.forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(entry.date).toLocaleDateString('fr-FR')}</td>
        <td>${entry.sector}</td>
        <td>${entry.bin}</td>
        <td>${entry.binType}</td>
        <td>${entry.bigContainer || ''}</td>
        <td class="mono">${entry.tare.toFixed(2)}</td>
        <td class="mono">${entry.grossWeight.toFixed(2)}</td>
        <td class="mono">${entry.netWeight.toFixed(2)}</td>
        <td class="delete-cell" title="Supprimer cette ligne">‚úñ</td>
      `;
      tr.querySelector('.delete-cell').addEventListener('click', () => {
        deleteEntry(entry);
      });
      historyTableBody.appendChild(tr);
    });
  }

  // Suppression entr√©e historique
  function deleteEntry(entryToDelete) {
    let history = loadHistory();
    const index = history.findIndex(e =>
      e.date === entryToDelete.date &&
      e.sector === entryToDelete.sector &&
      e.bin === entryToDelete.bin &&
      e.binType === entryToDelete.binType &&
      e.bigContainer === entryToDelete.bigContainer &&
      e.tare === entryToDelete.tare &&
      e.grossWeight === entryToDelete.grossWeight &&
      e.netWeight === entryToDelete.netWeight
    );
    if (index > -1) {
      history.splice(index, 1);
      saveHistory(history);
      renderTable();
      refreshFiltersTypes();
      refreshCharts();
      showMessage("Entr√©e supprim√©e.");
    }
  }

window.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('filterFrom').value = today;
  document.getElementById('filterTo').value = today;

  // Optionnel : lancer un premier rendu du tableau avec ce filtre par d√©faut
  renderTable();
});



  // Calcul agr√©gats pour graphiques
  function computeAggregates() {
    const data = getFilteredHistory();
    const bySector = {};
    const byType = {};
    const bigBagsCount = {};

    const bigBagTypes = ["Purge PE", "Purge PVC", "Aiguillettes"];

    data.forEach(e => {
      const net = Number(e.netWeight) || 0;

      if (!bySector[e.sector]) bySector[e.sector] = 0;
      bySector[e.sector] += net;

      if (e.binType && !bigBagTypes.includes(e.binType)) {
        if (!byType[e.binType]) byType[e.binType] = 0;
        byType[e.binType] += net;
      }

      if (e.binType && bigBagTypes.includes(e.binType)) {
        bigBagsCount[e.binType] = (bigBagsCount[e.binType] || 0) + 1;
      }
    });

    return { bySector, byType, bigBagsCount };
  }

  // Rendu graphique barre
  function renderBarChart(svg, dataMap, legendContainer, label) {
    svg.innerHTML = '';
    legendContainer.innerHTML = '';

    const entries = Object.entries(dataMap).sort((a,b) => b[1] - a[1]);
    if (!entries.length) {
      svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="#666" font-size="11">Aucune donn√©e</text>`;
      return;
    }

    const paddingLeft = 40;
    const paddingRight = 8;
    const paddingBottom = 20;
    const paddingTop = 12;

    const width = svg.clientWidth || svg.parentElement.clientWidth;
    const height = svg.clientHeight || 140;
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

    const maxValue = Math.max(...entries.map(e => e[1]));
    const barWidth = (width - paddingLeft - paddingRight) / entries.length * 0.6;
    const gap = (width - paddingLeft - paddingRight) / entries.length;

    entries.forEach(([name, value], i) => {
      const x = paddingLeft + i * gap + (gap - barWidth) / 2;
      const h = maxValue ? (value / maxValue) * (height - paddingTop - paddingBottom) : 0;
      const y = height - paddingBottom - h;
      let color;
      if (label === 'Type') {
        color = rgbaToHex(colorsByType[name] || "rgba(0,0,0,0.8)");
      } else {
        color = "#3b82f6";
      }

      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', barWidth);
      rect.setAttribute('height', h);
      rect.setAttribute('rx', 4);
      rect.setAttribute('fill', color);
      rect.setAttribute('fill-opacity', '1');
      svg.appendChild(rect);

      const textVal = document.createElementNS('http://www.w3.org/2000/svg','text');
      textVal.setAttribute('x', x + barWidth / 2);
      textVal.setAttribute('y', y - 4);
      textVal.setAttribute('text-anchor', 'middle');
      textVal.setAttribute('fill', '#e5e7eb');
      textVal.setAttribute('font-size', '9');
      textVal.textContent = Math.round(value);
      svg.appendChild(textVal);

      const labelText = document.createElementNS('http://www.w3.org/2000/svg','text');
      labelText.setAttribute('x', x + barWidth / 2);
      labelText.setAttribute('y', height - 6);
      labelText.setAttribute('text-anchor', 'middle');
      labelText.setAttribute('fill', '#9ca3af');
      labelText.setAttribute('font-size', '8');
      labelText.textContent = name;
      svg.appendChild(labelText);

      const li = document.createElement('div');
      li.className = 'legend-item';
      li.style.maxWidth = '120px';
      li.style.whiteSpace = 'normal';
      li.innerHTML = `<span class="legend-color" style="background:${color}"></span>${name}`;
      legendContainer.appendChild(li);
    });
  }

  // Rendu Big Bags avec pastille couleur
  function renderBigBags(bigBagsCount) {
    const container = document.getElementById('bigBagContainer');
    container.innerHTML = '';

    const allBigBagTypes = [
      "Purge PE",
      "Purge PVC",
      "Aiguillettes"
    ];

    const bigBagColors = {
      "Purge PE": "rgba(57, 255, 20, 0.9)",
      "Purge PVC": "rgba(255, 20, 147, 0.9)",
      "Aiguillettes": "rgba(255, 105, 180, 0.8)"
    };

    allBigBagTypes.forEach(type => {
      const count = bigBagsCount[type] || 0;

      const div = document.createElement('div');
      div.style.textAlign = 'center';
      div.style.color = '#ddd';
      div.style.fontSize = '0.85rem';
      div.style.userSelect = 'none';

      const img = document.createElement('img');
      img.src = 'bigbag.png';
      img.alt = type;
      img.style.width = '80px';
      img.style.height = '80px';
      img.style.objectFit = 'contain';
      img.style.marginBottom = '6px';

      const colorDot = document.createElement('span');
      colorDot.className = 'color-dot';
      colorDot.style.backgroundColor = bigBagColors[type] || 'transparent';

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = type;
      label.prepend(colorDot);

      const countSpan = document.createElement('div');
      countSpan.textContent = `x ${count}`;
      countSpan.style.fontWeight = '700';
      countSpan.style.color = '#ff4d4d';

      div.appendChild(img);
      div.appendChild(label);
      div.appendChild(countSpan);
      container.appendChild(div);
    });
  }

  // Rafra√Æchir graphiques
  function refreshCharts() {
    const { bySector, byType, bigBagsCount } = computeAggregates();
    renderBarChart(chartSectorSvg, bySector, legendSector, 'Secteur');
    renderBarChart(chartTypeSvg, byType, legendType, 'Type');
    renderBigBags(bigBagsCount);
  }

  // Construction texte export
  function buildPlainTextReport(includeCharts = false) {
    const history = loadHistory();

    let text = '=== NEXANS ‚Äì SUIVI DES BENNES (LOCAL) ===\n\n';
    text += 'HISTORIQUE DES PES√âES (dates sans heures)\n';
    text += '---------------------------------------------------------------------\n';
    text += 'Date | Secteur | Benne | Type | Grande benne | Tare (kg) | Brut (kg) | Net (kg)\n';

    history.forEach(e => {
      text += [
        new Date(e.date).toLocaleDateString('fr-FR'),
        e.sector,
        e.bin,
        e.binType,
        e.bigContainer || '',
        e.tare.toFixed(2),
        e.grossWeight.toFixed(2),
        e.netWeight.toFixed(2)
      ].join(' | ') + '\n';
    });

    if (includeCharts) {
      const { bySector, byType } = computeAggregates();
      text += '\n\nSYNTH√àSE PAR SECTEUR (poids net total en kg)\n';
      text += '---------------------------------------------------------------------\n';
      Object.entries(bySector).sort((a,b) => b[1]-a[1]).forEach(([name, value]) => {
        const bar = '‚ñà'.repeat(Math.min(40, Math.round(value / (Math.max(...Object.values(bySector)) || 1) * 40)));
        text += `${name.padEnd(14)} | ${value.toFixed(2).padStart(10)} kg | ${bar}\n`;
      });

      text += '\nSYNTH√àSE PAR TYPE DE D√âCHETS (poids net total en kg)\n';
      text += '---------------------------------------------------------------------\n';
      Object.entries(byType).sort((a,b) => b[1]-a[1]).forEach(([name, value]) => {
        const bar = '‚ñà'.repeat(Math.min(40, Math.round(value / (Math.max(...Object.values(byType)) || 1) * 40)));
        text += `${name.padEnd(18)} | ${value.toFixed(2).padStart(10)} kg | ${bar}\n`;
      });
    }

    return text;
  }

  // √âv√©nements export/copie
  copyTextBtn.addEventListener('click', async () => {
    const txt = buildPlainTextReport(false);
    try {
      await navigator.clipboard.writeText(txt);
      showMessage("Texte copi√© dans le presse-papiers.");
    } catch (e) {
      showMessage("Impossible de copier automatiquement. Copiez manuellement.");
      console.error(e);
    }
  });

  exportTextBtn.addEventListener('click', () => {
    const txt = buildPlainTextReport(true);
    const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const today = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = `nexans_pesees_${today}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showMessage("Fichier texte g√©n√©r√©.");
  });

  // Conversion SVG en PNG pour PDF
  async function svgToPngDataUrl(svgElement, width = 800, height = 280) {
    return new Promise((resolve, reject) => {
      const svgData = new XMLSerializer().serializeToString(svgElement);
      const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, width, height);
        ctx.drawImage(img, 0, 0, width, height);
        URL.revokeObjectURL(url);
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = e => {
        URL.revokeObjectURL(url);
        reject(e);
      };
      img.src = url;
    });
  }

  // Export PDF
  async function exportPdf() {
    try {
      if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API.autoTable) {
        showMessage("Erreur : biblioth√®ques jsPDF ou AutoTable non charg√©es correctement.");
        console.error("jsPDF ou AutoTable non disponibles.");
        return;
      }

      const pdf = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 40;
      let y = margin;

      pdf.setFontSize(32);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor('#ff4d4d');
      pdf.text('N', margin, y + 30);
      const nWidth = pdf.getTextWidth('N');
      pdf.setTextColor('#000000');
      pdf.text('EXANS', margin + nWidth, y + 30);
      y += 50;

      pdf.setDrawColor('#ff4d4d');
      pdf.setLineWidth(1.5);
      pdf.line(margin, y, pdf.internal.pageSize.getWidth() - margin, y);
      y += 20;

      const rows = getFilteredHistory();
      if (rows.length === 0) {
        showMessage("Aucune donn√©e √† exporter en PDF.");
        return;
      }

      const head = [['Date', 'Secteur', 'Benne', 'Type', 'Grande benne', 'Tare (kg)', 'Brut (kg)', 'Net (kg)']];
      const body = rows.map(r => [
        new Date(r.date).toLocaleDateString('fr-FR'),
        r.sector,
        r.bin,
        r.binType,
        r.bigContainer || '',
        r.tare.toFixed(2),
        r.grossWeight.toFixed(2),
        r.netWeight.toFixed(2)
      ]);

      pdf.autoTable({
        startY: y,
        head: head,
        body: body,
        theme: 'grid',
        headStyles: { fillColor: [255, 77, 77], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 8, textColor: 20 },
        margin: { left: margin, right: margin },
        didDrawPage: (data) => {
          y = data.cursor.y + 30;
        }
      });

      try {
        const sectorPng = await svgToPngDataUrl(chartSectorSvg);
        const typePng = await svgToPngDataUrl(chartTypeSvg);

        if (y + 20 + 280 * 2 + 20 > pdf.internal.pageSize.getHeight() - margin) {
          pdf.addPage();
          y = margin;
        }

        pdf.setFontSize(14);
        pdf.setTextColor('#ff4d4d');
        pdf.text('Synth√®se graphique', margin, y);
        y += 20;

        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pageWidth - margin * 2;
        const imgHeight = (imgWidth / 800) * 280;

        pdf.addImage(sectorPng, 'PNG', margin, y, imgWidth, imgHeight);
        y += imgHeight + 20;
        pdf.addImage(typePng, 'PNG', margin, y, imgWidth, imgHeight);

      } catch (e) {
        console.warn('Erreur lors de la conversion ou de l\'inclusion des graphiques dans le PDF:', e);
        showMessage('Erreur lors de l\'inclusion des graphiques dans le PDF.');
      }

      pdf.save(`nexans_pesees_${new Date().toISOString().slice(0,10)}.pdf`);
    } catch (err) {
      console.error("Erreur fatale lors de la g√©n√©ration du PDF:", err);
      showMessage('Erreur lors de la g√©n√©ration du PDF. V√©rifiez la console pour plus de d√©tails.');
    }
  }

  exportPdfBtn.addEventListener('click', () => {
    exportPdf();
  });

  // √âv√©nements formulaire principal
  sectorSelect.addEventListener('change', () => {
    populateBins();
  });
  binSelect.addEventListener('change', updateTare);
  grossWeightInput.addEventListener('input', calculateNetWeight);

  filterSector.addEventListener('change', () => {
    renderTable();
    refreshCharts();
  });
  filterType.addEventListener('change', () => {
    renderTable();
    refreshCharts();
  });
  filterFrom.addEventListener('change', () => {
    renderTable();
    refreshCharts();
  });
  filterTo.addEventListener('change', () => {
    renderTable();
    refreshCharts();
  });

  weightForm.addEventListener('submit', e => {
    e.preventDefault();
    const sec = sectorSelect.value;
    const idx = binSelect.value;
    if (!sec || idx === "") {
      showMessage("Veuillez s√©lectionner un secteur et une benne.");
      return;
    }
    const binObj = sectors[sec][idx];
    const tare = binObj.tare;
    const gross = parseFloat(grossWeightInput.value);
    const net = parseFloat(netWeightInput.value);

    if (!(gross > tare)) {
      showMessage("Le poids brut doit √™tre sup√©rieur √† la tare.");
      return;
    }

    const history = loadHistory();
    history.push({
      date: new Date().toISOString(),
      sector: sec,
      bin: `${binObj.type} : ${binObj.name}`,
      binType: binObj.name,
      bigContainer: bigContainerInput.value.trim(),
      tare,
      grossWeight: gross,
      netWeight: net
    });
    saveHistory(history);

    showMessage(`Pes√©e enregistr√©e (${net.toFixed(2)} kg net).`);

    weightForm.reset();
    tareWeightInput.value = '';
    netWeightInput.value = '';

    refreshFiltersTypes();
    renderTable();
    refreshCharts();
  });

  // Initialisation UI
  function initAdminUI() {
    renderSectorList();
    renderColorList();
    renderBinSectorSelect();
  }

  function init() {
    populateSectors();
    refreshFiltersTypes();
    renderTable();
    refreshCharts();
  }

  // Au chargement
  document.addEventListener('DOMContentLoaded', () => {
    initAdminUI();
    init();
  });
</script>
  </body>
</html>
